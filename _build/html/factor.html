
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>13. 퀀트 전략을 이용한 종목선정 &#8212; 파이썬을 이용한 퀀트 투자 포트폴리오 만들기</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "hyunyulhenry/quant_py");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "💬 comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14. 포트폴리오 구성 전략" href="portfolio.html" />
    <link rel="prev" title="12. 투자 참고용 데이터 수집" href="data_ref.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">파이썬을 이용한 퀀트 투자 포트폴리오 만들기</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   파이썬을 이용한 퀀트 투자 포트폴리오 만들기
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  퀀트와 프로그래밍 기초 배워보기
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="quant_intro.html">
   1. 퀀트에 대해 알아보기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="python.html">
   2. 파이썬 기초 배워보기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eda.html">
   3. 데이터 분석 배워보기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="plot.html">
   4. 데이터 시각화 배워보기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sql.html">
   5. SQL 기초 배워보기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sql_in_python.html">
   6. 파이썬에서 SQL 연결하기
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  크롤링을 이용한 데이터 수집
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="web.html">
   7. 크롤링을 위한 웹 기본지식
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="crawl_basic.html">
   8. 정적 크롤링 실습하기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="selenium.html">
   9. 동적 크롤링과 정규 표현식
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_korea.html">
   10. 국내 주식 데이터 수집
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_global.html">
   11. 전 세계 주식 데이터 수집하기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_ref.html">
   12. 투자 참고용 데이터 수집
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  포트폴리오 구성, 백테스트 및 매매하기
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   13. 퀀트 전략을 이용한 종목선정
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="portfolio.html">
   14. 포트폴리오 구성 전략
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="technical.html">
   15. 트레이딩을 위한 기술적 지표
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="backtest.html">
   16. 백테스팅 시뮬레이션
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="api_trading.html">
   17. 증권사 API 연결과 매매하기
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  부록
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="install_python.html">
   파이썬 다운로드 및 설치하기
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="install_sql.html">
   SQL 다운로드 및 설치하기
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/factor.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/hyunyulhenry/quant_py"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/hyunyulhenry/quant_py/issues/new?title=Issue%20on%20page%20%2Ffactor.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/hyunyulhenry/quant_py/main?urlpath=tree/factor.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   13.1. 팩터 이해하기
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   13.2. 베타 이해하기
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     13.2.1. 베타 계산하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   13.3. 밸류 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#datareader">
     13.3.1.
     <code class="docutils literal notranslate">
      <span class="pre">
       DataReader()
      </span>
     </code>
     함수를 이용한 팩터 데이터 다운로드
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pbr">
     13.3.2. PBR별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     13.3.3. 밸류 포트폴리오 구하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     13.3.4. 여러 지표 결합하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id8">
   13.4. 모멘텀 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     13.4.1. 모멘텀별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     13.4.2. 모멘텀 포트폴리오 구하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-ratio">
     13.4.3. K-Ratio
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   13.5. 퀄리티 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     13.5.1. 수익성별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id13">
     13.5.2. 우량성 포트폴리오 구하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id14">
   13.6. 마법공식
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     13.6.1. 퀄리티와 밸류 간의 관계
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id16">
     13.6.2. 마법공식 이해하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id17">
     13.6.3. 마법공식 포트폴리오
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id18">
   13.7. 섹터 중립 포트폴리오
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id19">
   13.8. 이상치 데이터 처리 및 팩터의 결합
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#trim">
     13.8.1. 트림(Trim): 이상치 데이터 삭제
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#winsorizing">
     13.8.2. 윈저라이징(Winsorizing): 이상치 데이터 대체
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id20">
     13.8.3. 팩터의 결합 방법
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id21">
   13.9. 멀티팩터 포트폴리오
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>퀀트 전략을 이용한 종목선정</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   13.1. 팩터 이해하기
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id3">
   13.2. 베타 이해하기
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     13.2.1. 베타 계산하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id5">
   13.3. 밸류 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#datareader">
     13.3.1.
     <code class="docutils literal notranslate">
      <span class="pre">
       DataReader()
      </span>
     </code>
     함수를 이용한 팩터 데이터 다운로드
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pbr">
     13.3.2. PBR별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     13.3.3. 밸류 포트폴리오 구하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     13.3.4. 여러 지표 결합하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id8">
   13.4. 모멘텀 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     13.4.1. 모멘텀별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id10">
     13.4.2. 모멘텀 포트폴리오 구하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#k-ratio">
     13.4.3. K-Ratio
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   13.5. 퀄리티 전략
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id12">
     13.5.1. 수익성별 포트폴리오의 수익률
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id13">
     13.5.2. 우량성 포트폴리오 구하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id14">
   13.6. 마법공식
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     13.6.1. 퀄리티와 밸류 간의 관계
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id16">
     13.6.2. 마법공식 이해하기
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id17">
     13.6.3. 마법공식 포트폴리오
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id18">
   13.7. 섹터 중립 포트폴리오
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id19">
   13.8. 이상치 데이터 처리 및 팩터의 결합
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#trim">
     13.8.1. 트림(Trim): 이상치 데이터 삭제
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#winsorizing">
     13.8.2. 윈저라이징(Winsorizing): 이상치 데이터 대체
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id20">
     13.8.3. 팩터의 결합 방법
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id21">
   13.9. 멀티팩터 포트폴리오
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="id1">
<h1><span class="section-number">13. </span>퀀트 전략을 이용한 종목선정<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>투자에 필요한 주가, 재무제표, 가치지표 데이터가 준비되었다면 퀀트 전략을 이용해 투자할 종목을 선정해야 한다. 퀀트 투자는 크게 포트폴리오 운용 전략과 트레이딩 전략으로 나눌 수 있다. 포트폴리오 운용 전략은 과거 주식 시장을 분석해 좋은 주식의 기준을 찾아낸 후 해당 기준에 만족하는 종목을 매수하거나, 이와 반대에 있는 나쁜 주식을 공매도하기도 한다. 투자의 속도가 느리며, 다수의 종목을 하나의 포트폴리오로 구성해 운용하는 특징이 있다. 반면 트레이딩 전략은 주식이 오르거나 내리는 움직임을 연구한 후 각종 지표를 이용해 매수 혹은 매도하는 전략이다. 투자의 속도가 빠르며 소수의 종목을 대상으로 한다. 이번 장에서는 퀀트 전략을 이용한 종목선정에 대해 알아보며, 트레이딩 전략에 대해서는 이후 장에서 살펴볼 것이다.</p>
<table class="colwidths-auto table" id="quant-type">
<caption><span class="caption-number">Table 13.1 </span><span class="caption-text">퀀트 투자 종류의 비교</span><a class="headerlink" href="#quant-type" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>기준</p></th>
<th class="head"><p>포트폴리오 운용 전략</p></th>
<th class="head"><p>트레이딩 전략</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>투자철학</p></td>
<td><p>규칙에 기반한 투자</p></td>
<td><p>규칙에 기반한 투자</p></td>
</tr>
<tr class="row-odd"><td><p>투자목적</p></td>
<td><p>좋은 주식을 매수</p></td>
<td><p>좋은 시점을 매수</p></td>
</tr>
<tr class="row-even"><td><p>학문적 기반</p></td>
<td><p>경제학, 통계학 등</p></td>
<td><p>통계학, 공학, 정보처리 등</p></td>
</tr>
<tr class="row-odd"><td><p>투자의 속도</p></td>
<td><p>느림</p></td>
<td><p>빠름</p></td>
</tr>
</tbody>
</table>
<div class="section" id="id2">
<h2><span class="section-number">13.1. </span>팩터 이해하기<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>하나 혹은 소수의 주식만을 연구해서 주식이 오르거나 내리는 공통적인 이유를 찾는 것은 불가능에 가깝지만, 그룹으로 살펴보면 어느 정도 파악이 가능하다. 어떠한 특성, 예를 들어 기업의 크기 별로 주식들을 묶은 후 수익률을 살펴보면, 크기가 큰 기업의 수익률이 좋았는지 아니면 작은 기업의 수익률이 좋았는지 알 수 있다. 즉, 오르는 주식과 내리는 주식은 애초에 가지고 있는 특성이 다르며 그로 인해 수익률에도 차이가 있다. 이처럼 주식의 수익률에 영향을 미치는 특성들을 ‘팩터(Factor)’라고 하며, 주식의 수익률은 이러한 팩터들로 대부분 설명된다. 주식이 가지고 있는 특성만 제대로 알아도 오를만한 주식을 선별하거나, 혹은 내릴만한 주식을 걸러낼 수 있다.</p>
<p>그러나 단순히 특성을 기준으로 수익률이 높거나 낮다고 해서 팩터로 인정되는 것은 아니다. 팩터로 인정되고 전략으로 사용되기 위해서는 아래의 조건을 충족해야 한다.</p>
<ul class="simple">
<li><p>지속성: 오랜 기간, 그리고 여러 경제 상황에서도 꾸준히 작동해야 한다. 몇 달 혹은 몇 년 동안의 기간에서만 작동한다면 우연의 결과일 가능성이 매우 크다.</p></li>
<li><p>범용성: 특정 국가에서만 작동하는 것이 아닌 다양한 국가, 지역, 섹터, 자산군에서도 작동해야 한다. 전세계 중 한국에서만 작동하는 전략이라면 이 역시 우연일 가능성이 크다.</p></li>
<li><p>이해 가능성: 전략이 작동하는 이유 및 지속 가능한지에 대한 설명이 가능해야 한다. 수익률이 높은 이유를 경제학이나 이론적으로 설명할 수 있어야 앞으로도 수익률이 높을 것이라 믿을 수 있다. 이유가 없는 효과는 우연 혹은 과최적화의 결과일 가능성이 매우 높다.</p></li>
<li><p>강건성: 같은 팩터라면 비슷한 정의(예: 가치주를 정의하는 PBR, PER, PSR 등) 모두에서 작동해야 한다. 전략이 작동하는 이유가 명확하다면 정의가 약간씩 달라도 당연히 작동해야 하며, 결과 역시 비슷해야 한다.</p></li>
<li><p>투자 가능성: 이론적으로만 작동하는 것이 아닌 실제로 투자가 가능해야 한다. 아무리 좋은 전략도 수수료, 세금, 법률적인 문제 등으로 실제 투자가 불가능하다면 돈을 벌 수 없기 때문이다.</p></li>
</ul>
<p>퀀트 운용 전략에서는 팩터의 강도가 양인 종목들로 구성한 포트폴리오는 향후 수익률이 높을 것으로 예상되어 매수를 하며, 팩터의 강도가 음인 종목들로 구성한 포트폴리오는 반대로 향후 수익률이 낮을 것으로 예상되어 매수를 하지 않거나 공매도를 한다. 이번 장에서는 투자에 많이 활용되는 기본적인 팩터들에 대해 알아보고, 우리가 구한 데이터를 바탕으로 각 팩터별 투자 종목을 선택하는 방법을 알아보겠다.</p>
</div>
<div class="section" id="id3">
<h2><span class="section-number">13.2. </span>베타 이해하기<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>투자자들이라면 누구나 한 번은 베타(Beta)라는 용어를 들어봤을 것이다. 기본적으로 전체 주식시장의 움직임은 개별 주식의 수익률에 가장 크게 영향을 주는 팩터일 수밖에 없다. 아무리 좋은 주식도 주식시장이 폭락한다면 같이 떨어지며, 아무리 나쁜 주식도 주식시장이 상승한다면 대부분 같이 오르기 마련이다.</p>
<p>개별 주식이 전체 주식시장의 변동에 반응하는 정도를 나타낸 값이 베타다. 베타가 1이라는 뜻은 주식시장과 움직임이 정확히 같다는 뜻으로서 시장 그 자체를 나타낸다. 베타가 1.5라는 뜻은 주식시장이 수익률이 +1%일 때 개별 주식의 수익률은 +1.5% 움직이며, 반대로 주식시장의 수익률이 -1%일 때 개별 주식의 수익률은 -1.5% 움직인다는 뜻이다. 반면 베타가 0.5라면 주식시장 수익률의 절반 정도만 움직인다.</p>
<table class="colwidths-auto table" id="beta">
<caption><span class="caption-number">Table 13.2 </span><span class="caption-text">베타에 따른 개별 주식의 수익률 움직임</span><a class="headerlink" href="#beta" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>베타</p></th>
<th class="head"><p>주식시장이 +1% 일 경우</p></th>
<th class="head"><p>주식시장이 -1% 일 경우</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0.5</p></td>
<td><p>+0.5%</p></td>
<td><p>-0.5%</p></td>
</tr>
<tr class="row-odd"><td><p>1.0</p></td>
<td><p>+1.0%</p></td>
<td><p>-1.0%</p></td>
</tr>
<tr class="row-even"><td><p>1.5</p></td>
<td><p>+1.5%</p></td>
<td><p>-1.5%</p></td>
</tr>
</tbody>
</table>
<p>이처럼 베타가 큰 주식은 주식시장보다 수익률의 움직임이 크며, 반대로 베타가 낮은 주식은 주식시장보다 수익률의 움직임이 작다. 따라서 일반적으로 상승장이 기대될 때는 베타가 큰 주식에, 하락장이 기대될 때는 베타가 낮은 주식에 투자하는 것이 좋다.</p>
<p>주식시장에서 베타는 통계학의 회귀분석모형에서 기울기를 나타내는 베타와 의미가 같다. 회귀분석모형은 <span class="math notranslate nohighlight">\(y = a + bx\)</span> 형태로 나타나며, 회귀계수인 <span class="math notranslate nohighlight">\(b\)</span>는 <span class="math notranslate nohighlight">\(x\)</span>의 변화에 따른 <span class="math notranslate nohighlight">\(y\)</span>의 변화의 기울기다. 이를 주식에 적용한 모형이 자산가격결정모형(CAPM: Capital Asset Pricing Model)이며, 그 식은 다음과 같다.</p>
<div class="math notranslate nohighlight">
\[회귀분석모형:\ y = a + bx\]</div>
<div class="math notranslate nohighlight">
\[자산가격결정모형: R_i = R_f + \beta_i \times [R_m - R_f]\]</div>
<p>먼저 회귀분석모형의 상수항인 <span class="math notranslate nohighlight">\(a\)</span>에 해당하는 부분은 무위험 수익률을 나타내는 <span class="math notranslate nohighlight">\(R_f\)</span>다. 독립변수인 <span class="math notranslate nohighlight">\(x\)</span>에 해당하는 부분은 무위험 수익률 대비 주식 시장의 초과 수익률을 나타내는 시장위험 프리미엄인 <span class="math notranslate nohighlight">\(R_m - R_f\)</span>이다. 종속변수인 <span class="math notranslate nohighlight">\(y\)</span>에 해당하는 부분은 개별주식의 수익률을 나타내는 <span class="math notranslate nohighlight">\(R_i\)</span>이며, 최종적으로 회귀계수인 <span class="math notranslate nohighlight">\(b\)</span>에 해당하는 부분은 개별 주식의 베타다.</p>
<table class="colwidths-auto table" id="beta-formulta">
<caption><span class="caption-number">Table 13.3 </span><span class="caption-text">회귀분석모형과 자산가격결정모형의 비교</span><a class="headerlink" href="#beta-formulta" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>구분</p></th>
<th class="head"><p>회귀분석모형</p></th>
<th class="head"><p>자산가격결정모형</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>상수항</p></td>
<td><p><span class="math notranslate nohighlight">\(a\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_f\)</span> (무위험수익률)</p></td>
</tr>
<tr class="row-odd"><td><p>독립변수</p></td>
<td><p><span class="math notranslate nohighlight">\(x\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_m - R_f\)</span> (시장위험 프리미엄)</p></td>
</tr>
<tr class="row-even"><td><p>종속변수</p></td>
<td><p><span class="math notranslate nohighlight">\(y\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_i\)</span> (개별주식의 수익률)</p></td>
</tr>
<tr class="row-odd"><td><p>회귀계수</p></td>
<td><p><span class="math notranslate nohighlight">\(b\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\beta_i\)</span> (개별주식의 베타)</p></td>
</tr>
</tbody>
</table>
<p>통계학에서 회귀계수는 <span class="math notranslate nohighlight">\(\beta = \frac{cov(x,y)}{\sigma_x^2}\)</span> 형태로 구할 수 있으며, <span class="math notranslate nohighlight">\(x\)</span>와 <span class="math notranslate nohighlight">\(y\)</span>에 각각 시장수익률과 개별주식의 수익률을 대입할 경우 개별주식의 베타는 <span class="math notranslate nohighlight">\(\beta_i= \rho(i,m) \times\frac{\sigma_i}{\sigma_m}\)</span> 형태로 구할 수 있다. 그러나 이러한 수식을 모르더라도 파이썬에서는 함수를 이용해 간단히 베타를 구할 수 있다.</p>
<div class="section" id="id4">
<h3><span class="section-number">13.2.1. </span>베타 계산하기<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>베타를 구하는 방법을 알아보기 위해 주식시장에 대한 대용치로 KOSPI 200 ETF, 개별주식으로는 전통적 고베타주인 증권주를 이용한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader</span> <span class="k">as</span> <span class="nn">web</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;102110.KS&#39;</span><span class="p">,</span> <span class="s1">&#39;039490.KS&#39;</span><span class="p">]</span>

<span class="n">all_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="n">all_data</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span>
                                      <span class="s1">&#39;yahoo&#39;</span><span class="p">,</span>
                                      <span class="n">start</span><span class="o">=</span><span class="s2">&quot;2016-01-01&quot;</span><span class="p">,</span>
                                      <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>

<span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">tic</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tic</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">all_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<ol class="simple">
<li><p>KOSPI 200 ETF인 TIGER 200(102110.KS), 증권주인 키움증권(039490.KS)의 티커를 입력한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DataReader()</span></code> 함수를 이용하여 해당 티커들의 2016년부터 2021년까지 데이터를 다운로드 받는다.</p></li>
<li><p>종가(Close)에 해당하는 열만 선택한 후, 데이터프레임 형태로 만들어준다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pct_change()</span></code> 함수를 통해 수익률을 계산한 후, NA 데이터는 삭제한다.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">ret</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">reg</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">ret</span><span class="p">[[</span><span class="s1">&#39;039490.KS&#39;</span><span class="p">]],</span> <span class="n">ret</span><span class="p">[[</span><span class="s1">&#39;102110.KS&#39;</span><span class="p">,</span> <span class="s1">&#39;intercept&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>증권주를 대상으로 베타를 구하기 위한 회귀분석을 실시한다. 자산가격결정모형의 수식인 <span class="math notranslate nohighlight">\(R_i = R_f + \beta_i \times [R_m - R_f]\)</span>에서 편의를 위해 무위험 수익률인 <span class="math notranslate nohighlight">\(R_f\)</span>를 0으로 가정하면, <span class="math notranslate nohighlight">\(R_i = \beta_i \times R_m\)</span>의 형태로 나타낼 수 있다. 이 중 <span class="math notranslate nohighlight">\(R_m\)</span>는 독립변수인 주식시장의 수익률을 의미하고, <span class="math notranslate nohighlight">\(R_i\)</span>는 종속변수인 개별 주식의 수익률을 의미한다.</p>
<ol class="simple">
<li><p>먼저 알파를 계산하기 위헤 intercept(절편)에 해당하는 열에 1을 입력한다.</p></li>
<li><p>종속변수에는 증권주, 독립변수에는 KOSPI 200 ETF 수익률 및 절편을 입력한다.</p></li>
<li><p>statsmodels 패키지의 <code class="docutils literal notranslate"><span class="pre">OLS()</span></code> 함수를 통해 손쉽게 선형회귀분석을 실시할 수 있으며, 회귀분석의 결과를 reg 변수에 저장한다.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>        <td>039490.KS</td>    <th>  R-squared:         </th> <td>   0.363</td> 
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.362</td> 
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   836.3</td> 
</tr>
<tr>
  <th>Date:</th>             <td>Sat, 30 Jul 2022</td> <th>  Prob (F-statistic):</th> <td>5.89e-146</td>
</tr>
<tr>
  <th>Time:</th>                 <td>14:56:08</td>     <th>  Log-Likelihood:    </th> <td>  3683.6</td> 
</tr>
<tr>
  <th>No. Observations:</th>      <td>  1472</td>      <th>  AIC:               </th> <td>  -7363.</td> 
</tr>
<tr>
  <th>Df Residuals:</th>          <td>  1470</td>      <th>  BIC:               </th> <td>  -7353.</td> 
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>102110.KS</th> <td>    1.3659</td> <td>    0.047</td> <td>   28.919</td> <td> 0.000</td> <td>    1.273</td> <td>    1.459</td>
</tr>
<tr>
  <th>intercept</th> <td>    0.0001</td> <td>    0.001</td> <td>    0.273</td> <td> 0.785</td> <td>   -0.001</td> <td>    0.001</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>197.090</td> <th>  Durbin-Watson:     </th> <td>   2.180</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.000</td>  <th>  Jarque-Bera (JB):  </th> <td> 453.385</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.765</td>  <th>  Prob(JB):          </th> <td>3.54e-99</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 5.247</td>  <th>  Cond. No.          </th> <td>    91.4</td>
</tr>
</table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>102110.KS    1.365893
intercept    0.000141
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">summary()</span></code> 메서드는 회귀분석 결과의 요약 정보를 보여준다. 또한 <code class="docutils literal notranslate"><span class="pre">reg.params</span></code> 을 통해 베타(102110.KS) 및 알파(intercept)에 해당하는 값만 선택할 수도 있다.</p>
<p>회귀분석의 결과 테이블 중 베타를 나타내는 부분은 coef 이다. 베타값이 약 1.36으로 높아 증권주의 특성인 고베타주임이 확인되며, t값 또한 약 28로써 유의성을 가르는 2 보다 크므로 결과가 유의하다고 볼 수 있다. 반면 알파(intercept)는 0.0001 수준이며 t값 역시 0.273로 매우 낮아, 증권주의 수익률은 주식 시장에 대한 노출도인 베타를 제외하고 나면 초과 수익이 없다고 볼 수 있다.</p>
</div>
</div>
<div class="section" id="id5">
<h2><span class="section-number">13.3. </span>밸류 전략<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>가치주 효과란 내재 가치 대비 낮은 가격의 주식(저PER, 저PBR 등)이, 내재 가치 대비 비싼 주식(고PER, 고PBR)보다 수익률이 높은 현상을 뜻한다. 가치주 효과가 발생하는 원인은 바로 사람들이 가치주(저밸류에이션)를 기피하고, 성장주(고밸류에이션)를 선호하기 때문이다. 달리 말하면 사람들이 기피한 것이 가치주가 되었다고 할 수도 있다. 가치주는 일반적으로 차입비율이 높고, 수익의 변동성이 크며, 경기가 좋지 않을 때 더 위험한 경향이 있다.사람들은 이처럼 위험한 주식에 필요 이상으로 과민 반응을 보인다. 그로 인해 주가가 하락하고 가치주가 되는 것이다. 반면 인간은 익숙한 것을 안전하다고 착각하는 경향이 있다. 최근 성과가 좋은 주식은 여러 매체를 통해 접하기 쉬운데, 이런 주식을 안전하다고 착각해 많은 사람이 매수에 나선다. 그로 인해 주가가 상승하고 고평가주가 된다. 보고 싶은 것만 보는 확증 편향으로 인해 투자자들은 위험하다고 생각되는 가치주가 망할 것 같은 이유만 찾아 더욱 기피하고, 안전하다고 생각되는 성장주는 영원히 상승할 것 같은 이유만 찾아 더욱 선호한다. 그러나 가치주가 생각보다 위험하지 않다는 것을, 성장주가 너무 많이 상승해 안전하지 않다는 것을 깨닫는 순간 주가는 원래 수준으로 회귀하기 마련이고, 이로 인해 가치주 효과가 발생한다.</p>
<div class="section" id="datareader">
<h3><span class="section-number">13.3.1. </span><code class="docutils literal notranslate"><span class="pre">DataReader()</span></code> 함수를 이용한 팩터 데이터 다운로드<a class="headerlink" href="#datareader" title="Permalink to this headline">¶</a></h3>
<p>주식시장 내에서 실제로 가치주 효과가 있는지 데이터로 확인해볼 필요가 있다. 파마-프렌치 3팩터로 유명한 케네스 프렌치 교수의 Data Library에는 각종 팩터에 관한 수익률이 매월 업데이트 되고 있다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">mba</span><span class="o">.</span><span class="n">tuck</span><span class="o">.</span><span class="n">dartmouth</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="n">pages</span><span class="o">/</span><span class="n">faculty</span><span class="o">/</span><span class="n">ken</span><span class="o">.</span><span class="n">french</span><span class="o">/</span><span class="n">data_library</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>또한 <code class="docutils literal notranslate"><span class="pre">DataReader()</span></code> 함수를 이용하면 해당 사이트의 데이터를 불러올 수 있어, 팩터 데이터를 매우 쉽게 분석할 수 있다. 먼저 어떠한 팩터 데이터가 있는지 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="nn">web</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">get_available_datasets</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="n">get_available_datasets</span><span class="p">()</span>
<span class="n">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;F-F_Research_Data_Factors_weekly&#39;,
 &#39;F-F_Research_Data_Factors_daily&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3&#39;,
 &#39;F-F_Research_Data_5_Factors_2x3_daily&#39;,
 &#39;Portfolios_Formed_on_ME&#39;,
 &#39;Portfolios_Formed_on_ME_Wout_Div&#39;,
 &#39;Portfolios_Formed_on_ME_Daily&#39;,
 &#39;Portfolios_Formed_on_BE-ME&#39;,
 &#39;Portfolios_Formed_on_BE-ME_Wout_Div&#39;,
 &#39;Portfolios_Formed_on_BE-ME_Daily&#39;,
 &#39;Portfolios_Formed_on_OP&#39;,
 &#39;Portfolios_Formed_on_OP_Wout_Div&#39;,
 &#39;Portfolios_Formed_on_OP_Daily&#39;,
 &#39;Portfolios_Formed_on_INV&#39;,
 &#39;Portfolios_Formed_on_INV_Wout_Div&#39;,
 &#39;Portfolios_Formed_on_INV_Daily&#39;,
 &#39;6_Portfolios_2x3&#39;,
 &#39;6_Portfolios_2x3_Wout_Div&#39;,
 &#39;6_Portfolios_2x3_weekly&#39;]
</pre></div>
</div>
</div>
</div>
<p>이 중 원하는 데이터의 이름을 찾는법은 다음과 같다. 먼저 홈페이지에서 원하는 팩터를 검색한 후, [CSV] 글자에서 마우스를 우클릭 해 [링크 주소 복사]를 누른다. PBR에 따른 수익률에 해당하는 ‘Portfolios Formed on Book-to-Market’의 다운로드 링크를 메모장 등에서 확인해보면 다음과 같습니다.</p>
<p><a class="reference external" href="https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/Portfolios_Formed_on_BE-ME_CSV.zip">https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/Portfolios_Formed_on_BE-ME_CSV.zip</a></p>
<p>이 중 끝부분의 ‘Portfolios_Formed_on_BE-ME_CSV’ 에서 _CSV 를 제외한 글자인 ‘Portfolios_Formed_on_BE-ME’를 <code class="docutils literal notranslate"><span class="pre">DataReader()</span></code> 함수 내에 입력하면 해당 데이터가 다운로드 된다.</p>
</div>
<div class="section" id="pbr">
<h3><span class="section-number">13.3.2. </span>PBR별 포트폴리오의 수익률<a class="headerlink" href="#pbr" title="Permalink to this headline">¶</a></h3>
<p>먼저 기업의 가치 여부를 판단할 때 가장 많이 사용되는 지표인 PBR을 기준으로 구성된 포트폴리오의 수익률을 비교해보겠다. 프렌치 라이브러리에서 해당 데이터의 이름은 ‘Portfolios_Formed_on_BE-ME’ 이다. B/M에서 B는 장부가치(Book Value), M는 시장가치(Market Value)로써, 이는 PBR의 역수라고 생각해도 된다. 즉 해당값이 높을수록 저PBR 주식을 의미한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="nn">web</span>

<span class="n">df_pbr</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;Portfolios_Formed_on_BE-ME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900-01-01&#39;</span><span class="p">)</span>
<span class="n">df_pbr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>&lt;= 0</th>
      <th>Lo 30</th>
      <th>Med 40</th>
      <th>Hi 30</th>
      <th>Lo 20</th>
      <th>Qnt 2</th>
      <th>Qnt 3</th>
      <th>Qnt 4</th>
      <th>Hi 20</th>
      <th>Lo 10</th>
      <th>Dec 2</th>
      <th>Dec 3</th>
      <th>Dec 4</th>
      <th>Dec 5</th>
      <th>Dec 6</th>
      <th>Dec 7</th>
      <th>Dec 8</th>
      <th>Dec 9</th>
      <th>Hi 10</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1926-07</th>
      <td>12.07</td>
      <td>5.55</td>
      <td>1.92</td>
      <td>1.06</td>
      <td>3.17</td>
      <td>5.41</td>
      <td>1.77</td>
      <td>2.44</td>
      <td>0.60</td>
      <td>4.55</td>
      <td>1.27</td>
      <td>11.40</td>
      <td>1.68</td>
      <td>1.50</td>
      <td>2.09</td>
      <td>2.73</td>
      <td>1.58</td>
      <td>0.63</td>
      <td>0.52</td>
    </tr>
    <tr>
      <th>1926-08</th>
      <td>-9.73</td>
      <td>2.65</td>
      <td>2.64</td>
      <td>6.09</td>
      <td>1.00</td>
      <td>4.01</td>
      <td>2.05</td>
      <td>4.58</td>
      <td>7.10</td>
      <td>0.18</td>
      <td>2.17</td>
      <td>6.40</td>
      <td>2.38</td>
      <td>1.58</td>
      <td>2.63</td>
      <td>4.46</td>
      <td>4.94</td>
      <td>8.31</td>
      <td>3.92</td>
    </tr>
    <tr>
      <th>1926-09</th>
      <td>-15.16</td>
      <td>1.28</td>
      <td>0.06</td>
      <td>-0.71</td>
      <td>-1.05</td>
      <td>3.05</td>
      <td>-0.30</td>
      <td>-0.17</td>
      <td>-1.46</td>
      <td>-0.09</td>
      <td>-2.39</td>
      <td>6.32</td>
      <td>0.73</td>
      <td>-0.89</td>
      <td>0.38</td>
      <td>-0.28</td>
      <td>0.17</td>
      <td>-2.16</td>
      <td>0.44</td>
    </tr>
    <tr>
      <th>1926-10</th>
      <td>-5.63</td>
      <td>-3.60</td>
      <td>-2.42</td>
      <td>-3.59</td>
      <td>-2.89</td>
      <td>-2.96</td>
      <td>-2.21</td>
      <td>-4.18</td>
      <td>-4.28</td>
      <td>-3.80</td>
      <td>-1.60</td>
      <td>-5.01</td>
      <td>-1.41</td>
      <td>-2.31</td>
      <td>-2.10</td>
      <td>-4.65</td>
      <td>-2.80</td>
      <td>-5.46</td>
      <td>-1.17</td>
    </tr>
    <tr>
      <th>1926-11</th>
      <td>5.58</td>
      <td>3.13</td>
      <td>2.92</td>
      <td>3.13</td>
      <td>4.11</td>
      <td>2.57</td>
      <td>1.89</td>
      <td>3.96</td>
      <td>2.48</td>
      <td>6.04</td>
      <td>1.41</td>
      <td>1.11</td>
      <td>3.63</td>
      <td>1.97</td>
      <td>1.80</td>
      <td>4.00</td>
      <td>3.85</td>
      <td>2.77</td>
      <td>1.76</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>딕셔너리 형태에 여러개의 테이블이 존재하며, 이 중 첫번째에 위치하는 데이터가 PBR을 기준으로 종목을 나눈 후 시가총액가중방식으로 포트폴리오를 구성하였을 경우 월간 수익률을 의미한다. 각 열에 대한 설명은 다음과 같다.</p>
<ul class="simple">
<li><p>&lt;=0: PBR이 0 이하인 기업들의 포트폴리오</p></li>
<li><p>Lo 30, Med 40, Hi 30: PBR 기준 상위 30%, 30-70%, 하위 30%로 나눈 포트폴리오</p></li>
<li><p>Lo 20, Qnt 2, Qnt 3, Qnt 4, Hi 20: PBR 기준 상위 20%, 20-40%, 40-60%, 60-80%, 80-100%로 나눈 포트폴리오</p></li>
<li><p>Lo 10, Dec 2, Dec 3, …, Dec 9, Hi 19: PBR 기준 상위 10% 씩으로 나눈 포트폴리오</p></li>
</ul>
<p>이 중 20%씩 나눈 [Lo 20, Qnt 2, Qnt 3, Qnt 4, Hi 20] 열만 선택하여 누적 수익률을 확인해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">unicode_minus</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df_pbr_vw</span> <span class="o">=</span> <span class="n">df_pbr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]]</span>
<span class="n">df_pbr_cum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_pbr_vw</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">df_pbr_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PBR별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_12_0.png" src="_images/factor_12_0.png" />
</div>
</div>
<ol class="simple">
<li><p>폰트 설정 및 유니코드 마이너스 기호를 쓰지 않도록 설정해준다.</p></li>
<li><p>원하는 열만 선택한다.</p></li>
<li><p>해당 사이트의 데이터는 1이 1%를 의미하므로, 올바른 계산을 위해 100으로 나누어준 후 <code class="docutils literal notranslate"><span class="pre">cumprod()</span></code> 메서드를 통해 누적 수익률을 계산한다.</p></li>
</ol>
<p>누적 수익률을 확인해보면, B/M 값이 높을 수록, 즉 PBR이 낮을 수록(Hi 20) 수익률이 높은 가치주 효과가 확인됩니다. 그러나 Hi 20과 다른 포트폴리오간의 수익률 차이가 너무 커 제대로된 비교가 되지 않는다. 이처럼 <span class="math notranslate nohighlight">\(y\)</span>축을 단순 수익률로 볼 경우 장기적인 성장률을 왜곡시키므로, 로그 수익률로 나타내는 것이 일반적이다. 단순 수익률(<span class="math notranslate nohighlight">\(r\)</span>)과 로그 수익률(<span class="math notranslate nohighlight">\(R\)</span>) 간의 관계는 다음과 같다.</p>
<div class="math notranslate nohighlight">
\[(1+r) = e^R\]</div>
<div class="math notranslate nohighlight">
\[log(1+r) = R\]</div>
<p>즉 단순 수익률에 1을 더한 후 로그를 취하면 로그 수익률을 구할 수 있다. 또한 단순 수익률은 누적 수익률을 계산할 때 <span class="math notranslate nohighlight">\((1+r_1)\times(1+r_2)\times\dots\times(1+r_n)\)</span> 처럼 곱을 해 나가지면 로그 수익률은 <span class="math notranslate nohighlight">\(R_1+R_2+\dots+R_n\)</span> 처럼 더하면 된다. 이는 아래의 관계 때문이다.</p>
<div class="math notranslate nohighlight">
\[(1+r_1)(1+r_2) = e^{R_1}e^{R_2} = e^{R_1+R_2}\]</div>
<div class="math notranslate nohighlight">
\[log(1+r_1)(1+r_2) = R_1+R_2\]</div>
<p>위의 관계를 이용해 로그 차트로 다시 나타내보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">df_pbr_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">df_pbr_vw</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">df_pbr_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PBR별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_14_0.png" src="_images/factor_14_0.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">log()</span></code> 함수를 이용해 로그 수익률을 계산해준 후 <code class="docutils literal notranslate"><span class="pre">cumsum()</span></code> 메서드를 통해 누적합을 구했다. 로그 수익률로 살펴보면 앞의 그래프보다 장기적인 성장률이 훨씬 더 잘 비교가 된다. 이번에는 PBR별 포트폴리오의 간단한 성과를 비교해보도록 하자. 연율화 수익률(기하), 연율화 수익률(산술), 연율화 변동성을 구하는 함수를 만들면 다음과 같다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">factor_stat</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">ret_ari</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>
    <span class="n">ret_geo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">sharp</span> <span class="o">=</span> <span class="n">ret_ari</span> <span class="o">/</span> <span class="n">vol</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">[</span><span class="n">ret_ari</span><span class="p">,</span> <span class="n">ret_geo</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">sharp</span><span class="p">],</span>
        <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;연율화 수익률(산술)&#39;</span><span class="p">,</span> <span class="s1">&#39;연율화 수익률(기하)&#39;</span><span class="p">,</span> <span class="s1">&#39;연율화 변동성&#39;</span><span class="p">,</span> <span class="s1">&#39;샤프지수&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">stat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="k">return</span> <span class="n">stat</span>
</pre></div>
</div>
</div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">len()</span></code> 함수를 통해 행 갯수를 구한다.</p></li>
<li><p>각 열의 연간 산술평균(ret_ari)을 구한다.</p></li>
<li><p>각 열의 연간 기하평균(ret_geo)를 구한다.</p></li>
<li><p>각 열의 변동성(vol)을 구한다.</p></li>
<li><p>기하평균에서 변동성을 나누어 샤프지수를 구한다.</p></li>
<li><p>하나의 데이터프레임으로 묶은 후 반올림을 한다.</p></li>
<li><p>산술 수익률, 기하 수익률, 변동성 항목은 100을 곱해 퍼센트 형태로 나타낸다.</p></li>
</ol>
<p>해당 함수를 PBR별 포트폴리오에 적용해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">factor_stat</span><span class="p">(</span><span class="n">df_pbr_vw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 20</th>
      <th>Qnt 2</th>
      <th>Qnt 3</th>
      <th>Qnt 4</th>
      <th>Hi 20</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>연율화 수익률(산술)</th>
      <td>11.0100</td>
      <td>11.2000</td>
      <td>12.2000</td>
      <td>12.8100</td>
      <td>15.8500</td>
    </tr>
    <tr>
      <th>연율화 수익률(기하)</th>
      <td>9.6300</td>
      <td>9.9000</td>
      <td>10.8500</td>
      <td>10.9200</td>
      <td>12.9300</td>
    </tr>
    <tr>
      <th>연율화 변동성</th>
      <td>18.7900</td>
      <td>18.6100</td>
      <td>19.5100</td>
      <td>22.3600</td>
      <td>27.8100</td>
    </tr>
    <tr>
      <th>샤프지수</th>
      <td>0.5858</td>
      <td>0.6018</td>
      <td>0.6256</td>
      <td>0.5731</td>
      <td>0.5699</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Hi 20 즉 PBR이 가장 낮은 종목들로 구성된 포트폴리오의 수익률이 가장 높으며, 반대로 Low 20 즉 PBR이 가장 높은 종목들로 구성된 포트폴리오의 수익률은 가장 낮다.</p>
<p>프렌치 라이브러리에는 B/M(PBR) 외에도 E/P(PER), CF/P(PCR) 데이터도 존재하므로, 해당 지표 역시 누적 수익률을 확인해보도록 하자. 먼저 PER의 역수에 해당하는 E/P 지표의 누적 수익률은 다음과 같다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_per</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;Portfolios_Formed_on_E-P&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900-01-01&#39;</span><span class="p">)</span>
<span class="n">df_per_vw</span> <span class="o">=</span> <span class="n">df_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]]</span>
<span class="n">df_per_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_per_vw</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">df_per_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PER별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_20_0.png" src="_images/factor_20_0.png" />
</div>
</div>
<p>Hi 20, 즉 PER가 낮을 수록 수익률이 높다. 이번에는 PCR의 역수에 해당하는 CF/P 지표의 누적 수익률을 살펴보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_pcr</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;Portfolios_Formed_on_CF-P&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900-01-01&#39;</span><span class="p">)</span>
<span class="n">df_pcr_vw</span> <span class="o">=</span> <span class="n">df_pcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span><span class="p">]]</span>
<span class="n">df_pcr_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_pcr_vw</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">df_pcr_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PCR별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_22_0.png" src="_images/factor_22_0.png" />
</div>
</div>
<p>역시나 Hi 20, 즉 PCR이 낮을 수록 수익률이 높다. 즉, PBR 뿐만 아니라 PER, PCR과 같은 모든 지표에서 가치주 효과가 나타난다.</p>
</div>
<div class="section" id="id6">
<h3><span class="section-number">13.3.3. </span>밸류 포트폴리오 구하기<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>가치주에 투자하는 것이 훨씬 수익률이 높다는 점을 확인하였으니, 국내 종목들 중 가치주에는 어떠한 것이 있는 확인해보도록 하자. 먼저 국내 기업 중 전통적인 가치지표인 PER와 PBR이 낮은 종목을 선정해보도록 하겠다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_ticker</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="s2">	and 종목구분 = &#39;보통주&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">value_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_value</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_value);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>먼저 DB에서 티커 테이블과 가치지표 테이블을 불러온다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_list</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">value_pivot</span> <span class="o">=</span> <span class="n">value_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;지표&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;값&#39;</span><span class="p">)</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">value_pivot</span><span class="p">,</span>
                                               <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                               <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>일부 종목은 가치지표가 0보다 작은 경우(예: 적자기업의 경우 PER가 음수, 혹은 배당수익률이 0%인 종목)가 있으며 이러한 데이터는 nan으로 변경한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pivot()</span></code> 함수를 통해 가치지표 테이블을 가로로 긴 형태로 변경한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">merge()</span></code> 함수를 통해티커 테이블과 가치지표 테이블을 합친다.</p></li>
</ol>
<p>이제 PER와 PBR이 낮은 종목을 찾아보도록 한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_rank</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[[</span><span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PBR&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">value_sum</span> <span class="o">=</span> <span class="n">value_rank</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
<span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_sum</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">,</span> <span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PBR&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>PER</th>
      <th>PBR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>41</th>
      <td>000880</td>
      <td>한화</td>
      <td>1.1202</td>
      <td>0.0905</td>
    </tr>
    <tr>
      <th>66</th>
      <td>001390</td>
      <td>KG케미칼</td>
      <td>1.2850</td>
      <td>0.1935</td>
    </tr>
    <tr>
      <th>95</th>
      <td>001940</td>
      <td>KISCO홀딩스</td>
      <td>1.1415</td>
      <td>0.1633</td>
    </tr>
    <tr>
      <th>97</th>
      <td>002030</td>
      <td>아세아</td>
      <td>1.3288</td>
      <td>0.1519</td>
    </tr>
    <tr>
      <th>158</th>
      <td>003380</td>
      <td>하림지주</td>
      <td>1.5011</td>
      <td>0.2198</td>
    </tr>
    <tr>
      <th>264</th>
      <td>005990</td>
      <td>매일홀딩스</td>
      <td>1.3858</td>
      <td>0.1847</td>
    </tr>
    <tr>
      <th>270</th>
      <td>006120</td>
      <td>SK디스커버리</td>
      <td>1.8790</td>
      <td>0.2213</td>
    </tr>
    <tr>
      <th>375</th>
      <td>009970</td>
      <td>영원무역홀딩스</td>
      <td>1.2968</td>
      <td>0.2144</td>
    </tr>
    <tr>
      <th>524</th>
      <td>017940</td>
      <td>E1</td>
      <td>1.9390</td>
      <td>0.2191</td>
    </tr>
    <tr>
      <th>580</th>
      <td>023590</td>
      <td>다우기술</td>
      <td>1.0483</td>
      <td>0.1868</td>
    </tr>
    <tr>
      <th>599</th>
      <td>024830</td>
      <td>세원물산</td>
      <td>1.9279</td>
      <td>0.2293</td>
    </tr>
    <tr>
      <th>672</th>
      <td>032190</td>
      <td>다우데이타</td>
      <td>0.5300</td>
      <td>0.0874</td>
    </tr>
    <tr>
      <th>746</th>
      <td>036000</td>
      <td>예림당</td>
      <td>1.4662</td>
      <td>0.2096</td>
    </tr>
    <tr>
      <th>781</th>
      <td>037400</td>
      <td>우리엔터프라이즈</td>
      <td>1.2233</td>
      <td>0.2674</td>
    </tr>
    <tr>
      <th>1039</th>
      <td>058650</td>
      <td>세아홀딩스</td>
      <td>2.3269</td>
      <td>0.1343</td>
    </tr>
    <tr>
      <th>1317</th>
      <td>088350</td>
      <td>한화생명</td>
      <td>1.8846</td>
      <td>0.1500</td>
    </tr>
    <tr>
      <th>1365</th>
      <td>092230</td>
      <td>KPX홀딩스</td>
      <td>1.7530</td>
      <td>0.1838</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>101360</td>
      <td>이엔드디</td>
      <td>0.2037</td>
      <td>0.2037</td>
    </tr>
    <tr>
      <th>1631</th>
      <td>139480</td>
      <td>이마트</td>
      <td>1.3678</td>
      <td>0.2598</td>
    </tr>
    <tr>
      <th>1655</th>
      <td>146320</td>
      <td>비씨엔씨</td>
      <td>0.2924</td>
      <td>0.2924</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank()</span></code> 함수를 통해 PER와 PBR 열의 순위를 구하며, <code class="docutils literal notranslate"><span class="pre">axis</span> <span class="pre">=</span> <span class="pre">0</span></code>을 입력하여 순위는 열 방향으로 구한다. 즉 PER 내에서의 순위, PBR 내에서의 순위를 구한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sum()</span></code> 함수 내에 <code class="docutils literal notranslate"><span class="pre">axis</span> <span class="pre">=</span> <span class="pre">1</span></code>를 통해 위에서 구한 순위를 행 방향으로 값을 더하며, skipna = False를 통해 NA가 있는 종목은 제외한다. 그 후 다시 <code class="docutils literal notranslate"><span class="pre">rank()</span></code> 함수를 통해 순위의 합 기준으로 다시 순위를 구한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">value_sum</span> <span class="pre">&lt;=</span> <span class="pre">20</span></code> 즉 순위가 낮은 20 종목을 선택한다. 이는 PER과 PBR가 낮은 종목이라고 볼 수 있다.</p></li>
</ol>
<p>전통적으로 PER와 PBR이 낮은 금융주 및 지주회사가 많이 분포되어 있다.</p>
</div>
<div class="section" id="id7">
<h3><span class="section-number">13.3.4. </span>여러 지표 결합하기<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>이번에는 가치지표에 해당하는 모든 지표, 즉  PER, PBR, PCR, PSR, DY를 고려한 밸류 포트폴리오를 만들어보도록 하겠다. 먼저 각 지표 별 상관관계를 살펴보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">value_list_copy</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">value_list_copy</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">value_list_copy</span><span class="p">[</span><span class="s1">&#39;DY&#39;</span><span class="p">]</span>
<span class="n">value_list_copy</span> <span class="o">=</span> <span class="n">value_list_copy</span><span class="p">[[</span><span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PBR&#39;</span><span class="p">,</span> <span class="s1">&#39;PCR&#39;</span><span class="p">,</span> <span class="s1">&#39;PSR&#39;</span><span class="p">,</span> <span class="s2">&quot;DY&quot;</span><span class="p">]]</span>
<span class="n">value_rank_all</span> <span class="o">=</span> <span class="n">value_list_copy</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">value_rank_all</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">value_rank_all</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">value_rank_all</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_30_0.png" src="_images/factor_30_0.png" />
</div>
</div>
<ol class="simple">
<li><p>PER, PBR, PCR, PSR의 경우 값이 낮을수록 가치주에 해당하지만, DY의 경우 값이 높을수록 배당수익률이 높은 가치주에 해당한다. 따라서 DY에 역수를 취해 순서를 맞춰준다.</p></li>
<li><p>각 지표의 순위를 열 방향으로 구한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">heatmap()</span></code> 함수를 통해 지표 별 상관관계를 히트맵으로 나타낸다.</p></li>
</ol>
<p>비슷한 가치지표임에도 불구하고 서로 간의 상관관계가 꽤 낮은 지표도 있다. 따라서 지표를 통합적으로 고려하면 분산효과를 기대할 수도 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_sum_all</span> <span class="o">=</span> <span class="n">value_rank_all</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
<span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_sum_all</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
    </tr>
    <tr>
      <th>8</th>
      <td>000140</td>
      <td>하이트진로홀딩스</td>
      <td>0.0393</td>
      <td>0.2451</td>
      <td>0.8968</td>
      <td>3.5055</td>
      <td>0.1186</td>
    </tr>
    <tr>
      <th>41</th>
      <td>000880</td>
      <td>한화</td>
      <td>0.0307</td>
      <td>0.0905</td>
      <td>0.3759</td>
      <td>1.1202</td>
      <td>0.0344</td>
    </tr>
    <tr>
      <th>49</th>
      <td>001040</td>
      <td>CJ</td>
      <td>0.0294</td>
      <td>0.1388</td>
      <td>0.8653</td>
      <td>2.7127</td>
      <td>0.0641</td>
    </tr>
    <tr>
      <th>66</th>
      <td>001390</td>
      <td>KG케미칼</td>
      <td>0.0202</td>
      <td>0.1935</td>
      <td>1.0924</td>
      <td>1.2850</td>
      <td>0.0650</td>
    </tr>
    <tr>
      <th>95</th>
      <td>001940</td>
      <td>KISCO홀딩스</td>
      <td>0.0286</td>
      <td>0.1633</td>
      <td>1.5793</td>
      <td>1.1415</td>
      <td>0.1287</td>
    </tr>
    <tr>
      <th>96</th>
      <td>002020</td>
      <td>코오롱</td>
      <td>0.0225</td>
      <td>0.2927</td>
      <td>0.9884</td>
      <td>1.5913</td>
      <td>0.0564</td>
    </tr>
    <tr>
      <th>97</th>
      <td>002030</td>
      <td>아세아</td>
      <td>0.0258</td>
      <td>0.1519</td>
      <td>1.4212</td>
      <td>1.3288</td>
      <td>0.1337</td>
    </tr>
    <tr>
      <th>139</th>
      <td>002990</td>
      <td>금호건설</td>
      <td>0.0984</td>
      <td>0.4743</td>
      <td>1.8186</td>
      <td>2.2026</td>
      <td>0.1455</td>
    </tr>
    <tr>
      <th>155</th>
      <td>003300</td>
      <td>한일홀딩스</td>
      <td>0.0514</td>
      <td>0.1710</td>
      <td>2.1805</td>
      <td>4.3182</td>
      <td>0.1802</td>
    </tr>
    <tr>
      <th>185</th>
      <td>004020</td>
      <td>현대제철</td>
      <td>0.0303</td>
      <td>0.2449</td>
      <td>2.2590</td>
      <td>2.4871</td>
      <td>0.1771</td>
    </tr>
    <tr>
      <th>264</th>
      <td>005990</td>
      <td>매일홀딩스</td>
      <td>0.0169</td>
      <td>0.1847</td>
      <td>1.0814</td>
      <td>1.3858</td>
      <td>0.0663</td>
    </tr>
    <tr>
      <th>325</th>
      <td>008060</td>
      <td>대덕</td>
      <td>0.0461</td>
      <td>0.1610</td>
      <td>0.6830</td>
      <td>2.8991</td>
      <td>0.1512</td>
    </tr>
    <tr>
      <th>358</th>
      <td>009410</td>
      <td>태영건설</td>
      <td>0.0518</td>
      <td>0.3739</td>
      <td>0.6477</td>
      <td>4.3037</td>
      <td>0.0932</td>
    </tr>
    <tr>
      <th>375</th>
      <td>009970</td>
      <td>영원무역홀딩스</td>
      <td>0.0417</td>
      <td>0.2144</td>
      <td>2.0295</td>
      <td>1.2968</td>
      <td>0.1877</td>
    </tr>
    <tr>
      <th>379</th>
      <td>010100</td>
      <td>한국프랜지</td>
      <td>0.0354</td>
      <td>0.2981</td>
      <td>1.3225</td>
      <td>4.4796</td>
      <td>0.0727</td>
    </tr>
    <tr>
      <th>474</th>
      <td>014790</td>
      <td>한라</td>
      <td>0.0254</td>
      <td>0.3676</td>
      <td>1.6161</td>
      <td>1.3811</td>
      <td>0.1042</td>
    </tr>
    <tr>
      <th>724</th>
      <td>034730</td>
      <td>SK</td>
      <td>0.0374</td>
      <td>0.2502</td>
      <td>2.9369</td>
      <td>1.9486</td>
      <td>0.1482</td>
    </tr>
    <tr>
      <th>1230</th>
      <td>078930</td>
      <td>GS</td>
      <td>0.0498</td>
      <td>0.2804</td>
      <td>2.3288</td>
      <td>2.0978</td>
      <td>0.1626</td>
    </tr>
    <tr>
      <th>2003</th>
      <td>267290</td>
      <td>경동도시가스</td>
      <td>0.0412</td>
      <td>0.3335</td>
      <td>1.6861</td>
      <td>5.2859</td>
      <td>0.0768</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>위에서 구한 다섯개 지표들의 순위를 더한 후 다시 순위를 매긴다.</p></li>
<li><p>최종 순위가 낮은 20 종목을 선택한다. 즉 하나의 지표보다 다섯개 지표가 골고루 낮은 종목을 선택한다.</p></li>
</ol>
<p>단순 저PER, 저PBR 포트폴리오와 달리 금융주 및 지주회사가 아닌 종목들도 포함되어 있다.</p>
</div>
</div>
<div class="section" id="id8">
<h2><span class="section-number">13.4. </span>모멘텀 전략<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>투자에서 모멘텀이란 주가 혹은 이익의 추세로서, 상승 추세의 주식은 지속적으로 상승하며 하락 추세의 주식은 지속적으로 하락하는 현상을 말한다. 모멘텀의 종류는 크게 기업의 이익에 대한 추세를 나타내는 이익 모멘텀과 주가의 모멘텀에 대한 가격 모멘텀이 있으며, 이 중에서 3개월에서 12개월 가격 모멘텀을 흔히 모멘텀이라고 한다. 즉 과거 12개월 수익률이 높았던 종목이 계속해서 상승하는 현상을 모멘텀이라 한다.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>계산 기간에 따른 가격 모멘텀의 종류</p>
<ul class="simple">
<li><p>단기 모멘텀: 최근 한 주 혹은 1개월 수익률이 높을(수록) 차월 수익률이 낮은(높은) 현상. 단기 수익률 반전 현상이라고도 함.</p></li>
<li><p>중기 모멘텀: 최근 3~12개월 수익률이 높았던 주식이 향후에도 지속적으로 상승하는 현상.</p></li>
<li><p>장기 모멘텀: 최근 3~5년 수익률이 낮았던 종목들이, 수익률이 높았던 종목보다 성과가 높은 현상. 장기 수익률 반전 현상이라고도 함.</p></li>
</ul>
</div>
<p>모멘텀 효과가 발생하는 이유는 기업의 가치 변화에 대한 사람들의 반응 때문이다. 기업의 이익이 증가하면 내재가치(펀더멘털 가치) 역시 증가하고, 이러한 가치는 <a class="reference internal" href="#momentum"><span class="std std-numref">Fig. 13.1</span></a>에서 실선으로 표시된 바와 같이 즉각적으로 변한다. 반면 점선으로 표시된 주식의 가격은 늘 새로운 정보에 반응해 상승하기는 하지만, 초기에는 이익에 대한 과소 반응으로 인해 상승폭이 낮으며 그 이후 계속해서 상승한다. 주식의 가격이 가치에 수렴하기 위해 상승하다 보면 투자자들의 주목을 끌기 마련이며, 양떼 효과로 인해 따라서 투자하는 이들이 많아진다. 그 결과, 과잉 반응이 발생해 주가는 계속해서 상승하며 모멘텀 효과가 발생한다. 그러나 투자자들이 기업의 가치에 비해 주가가 너무 비싸졌다고 판단하는 순간 주가는 하락하기 시작하며 반전이 이루어진다.</p>
<div class="figure align-default" id="momentum">
<img alt="_images/momentum.png" src="_images/momentum.png" />
<p class="caption"><span class="caption-number">Fig. 13.1 </span><span class="caption-text">내재가치 변화에 따른 시장가격의 반응</span><a class="headerlink" href="#momentum" title="Permalink to this image">¶</a></p>
<div class="legend">
<p>출처: Hurst, Ooi, and Pedersen (2013)</p>
</div>
</div>
<div class="section" id="id9">
<h3><span class="section-number">13.4.1. </span>모멘텀별 포트폴리오의 수익률<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>최근 12개월 수익률을 기준으로 구성된 포트폴리오의 수익률을 비교해보겠다. 프렌치 라이브러이에서 해당 데이터의 이름은 ‘10_Portfolios_Prior_12_2’ 이다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas_datareader.data</span> <span class="k">as</span> <span class="nn">web</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="n">df_mom</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;10_Portfolios_Prior_12_2&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;famafrench&#39;</span><span class="p">,</span>
                        <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1900-01-01&#39;</span><span class="p">)</span>
<span class="n">df_mom_vw</span> <span class="o">=</span> <span class="n">df_mom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df_mom_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_mom_vw</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">unicode_minus</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df_mom_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;모멘텀별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_34_0.png" src="_images/factor_34_0.png" />
</div>
</div>
<p>모멘텀별 포트폴리오의 누적수익률을 확인해보면, 최근 12개월 수익률이 높을수록(Hi PRIOR) 향후에도 지속적으로 수익률이 높으며, 최근 12월 수익률이 낮을수록(Lo PRIOR) 향후에도 수익률이 낮은 ‘모멘텀 현상’이 존재한다. 이번에는 앞서 작성한 <code class="docutils literal notranslate"><span class="pre">factor_stat()</span></code> 함수를 이용해 포트폴리오별 통계값을 확인해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">factor_stat</span><span class="p">(</span><span class="n">df_mom_vw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo PRIOR</th>
      <th>PRIOR 2</th>
      <th>PRIOR 3</th>
      <th>PRIOR 4</th>
      <th>PRIOR 5</th>
      <th>PRIOR 6</th>
      <th>PRIOR 7</th>
      <th>PRIOR 8</th>
      <th>PRIOR 9</th>
      <th>Hi PRIOR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>연율화 수익률(산술)</th>
      <td>3.8100</td>
      <td>8.7600</td>
      <td>9.1000</td>
      <td>10.8900</td>
      <td>10.6900</td>
      <td>11.460</td>
      <td>12.1600</td>
      <td>13.2900</td>
      <td>14.1900</td>
      <td>17.7300</td>
    </tr>
    <tr>
      <th>연율화 수익률(기하)</th>
      <td>-1.6900</td>
      <td>5.1200</td>
      <td>6.4900</td>
      <td>8.9200</td>
      <td>9.0000</td>
      <td>9.930</td>
      <td>10.8700</td>
      <td>12.2500</td>
      <td>13.0200</td>
      <td>16.3100</td>
    </tr>
    <tr>
      <th>연율화 변동성</th>
      <td>34.1600</td>
      <td>28.0600</td>
      <td>24.0600</td>
      <td>21.9300</td>
      <td>20.4900</td>
      <td>19.970</td>
      <td>18.9300</td>
      <td>18.3400</td>
      <td>19.3700</td>
      <td>22.2900</td>
    </tr>
    <tr>
      <th>샤프지수</th>
      <td>0.1115</td>
      <td>0.3121</td>
      <td>0.3784</td>
      <td>0.4966</td>
      <td>0.5219</td>
      <td>0.574</td>
      <td>0.6423</td>
      <td>0.7246</td>
      <td>0.7327</td>
      <td>0.7953</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="id10">
<h3><span class="section-number">13.4.2. </span>모멘텀 포트폴리오 구하기<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>최근 12개월 수익률이 높은 주식에 투자하는 것이 훨씬 수익률이 높다는 점을 확인하였으니, 국내 종목들 중 모멘텀 주식에는 어떠한 것이 있는 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">select * from kor_ticker</span>
<span class="sd">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="sd">	and 종목구분 = &#39;보통주&#39;;</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>


<span class="n">price_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">select 날짜, 종가, 종목코드</span>
<span class="sd">from kor_price</span>
<span class="sd">where 날짜 &gt;= (select (select max(날짜) from kor_price) - interval 1 year);</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<span class="n">price_list</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>날짜</th>
      <th>종가</th>
      <th>종목코드</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-07-26</td>
      <td>14400</td>
      <td>000020</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-07-26</td>
      <td>1240</td>
      <td>000040</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-07-26</td>
      <td>13300</td>
      <td>000050</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-07-26</td>
      <td>22800</td>
      <td>000060</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-07-26</td>
      <td>115500</td>
      <td>000070</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>먼저 DB에서 티커 테이블과 가격 테이블을 불러온다. 가격의 경우 <code class="docutils literal notranslate"><span class="pre">where</span> <span class="pre">날짜</span> <span class="pre">&gt;=</span> <span class="pre">(select</span> <span class="pre">(select</span> <span class="pre">max(날짜)</span> <span class="pre">from</span> <span class="pre">kor_price)</span> <span class="pre">-</span> <span class="pre">interval</span> <span class="pre">1</span> <span class="pre">year)</span></code> 부분을 통해 테이블에서 최근일 기준 1년전의 날짜를 구한 후, 해당일 이후인 최근 1년치 가격 정보만 불러온다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_pivot</span> <span class="o">=</span> <span class="n">price_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;날짜&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;종가&#39;</span><span class="p">)</span>
<span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>종목코드</th>
      <th>000020</th>
      <th>000040</th>
      <th>000050</th>
      <th>000060</th>
      <th>000070</th>
    </tr>
    <tr>
      <th>날짜</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-07-26</th>
      <td>14400.0</td>
      <td>1240.0</td>
      <td>13300.0</td>
      <td>22800.0</td>
      <td>115500.0</td>
    </tr>
    <tr>
      <th>2021-07-27</th>
      <td>14400.0</td>
      <td>1250.0</td>
      <td>13350.0</td>
      <td>23350.0</td>
      <td>117000.0</td>
    </tr>
    <tr>
      <th>2021-07-28</th>
      <td>14450.0</td>
      <td>1235.0</td>
      <td>13200.0</td>
      <td>23850.0</td>
      <td>115000.0</td>
    </tr>
    <tr>
      <th>2021-07-29</th>
      <td>14600.0</td>
      <td>1255.0</td>
      <td>13450.0</td>
      <td>24950.0</td>
      <td>111000.0</td>
    </tr>
    <tr>
      <th>2021-07-30</th>
      <td>14650.0</td>
      <td>1235.0</td>
      <td>13600.0</td>
      <td>25500.0</td>
      <td>109000.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pivot()</span></code> 함수를 통해 가격 테이블을 가로로 긴 형태로 변경한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ret_list</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>-0.253472</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>-0.420968</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>-0.022556</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>0.460526</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>-0.360173</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>가격 테이블(price_pivot)에서 가장 끝 행(<code class="docutils literal notranslate"><span class="pre">price_pivot.iloc[-1]</span></code>)을 가장 첫 행(<code class="docutils literal notranslate"><span class="pre">price_pivot.iloc[0]</span></code>)으로 나누어 각 종목의 12개월 수익률을 구한 후, 데이터프레임 형태로 만든다.</p></li>
<li><p>티커 테이블에 해당 내역을 합친다.</p></li>
</ol>
<p>이제 12개월 수익률이 높은 종목을 찾아보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">momentum_rank</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data_bind</span><span class="p">[</span><span class="n">momentum_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>13</th>
      <td>000230</td>
      <td>일동홀딩스</td>
      <td>1.154412</td>
    </tr>
    <tr>
      <th>125</th>
      <td>002710</td>
      <td>TCC스틸</td>
      <td>1.242188</td>
    </tr>
    <tr>
      <th>208</th>
      <td>004690</td>
      <td>삼천리</td>
      <td>1.043189</td>
    </tr>
    <tr>
      <th>257</th>
      <td>005860</td>
      <td>한일사료</td>
      <td>1.548315</td>
    </tr>
    <tr>
      <th>314</th>
      <td>007660</td>
      <td>이수페타시스</td>
      <td>1.127788</td>
    </tr>
    <tr>
      <th>420</th>
      <td>011700</td>
      <td>한신기계</td>
      <td>1.061538</td>
    </tr>
    <tr>
      <th>503</th>
      <td>016710</td>
      <td>대성홀딩스</td>
      <td>1.093385</td>
    </tr>
    <tr>
      <th>505</th>
      <td>016790</td>
      <td>카나리아바이오</td>
      <td>10.216964</td>
    </tr>
    <tr>
      <th>974</th>
      <td>053050</td>
      <td>지에스이</td>
      <td>1.497512</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>054210</td>
      <td>이랜텍</td>
      <td>1.617450</td>
    </tr>
    <tr>
      <th>1019</th>
      <td>056090</td>
      <td>이노시스</td>
      <td>1.821497</td>
    </tr>
    <tr>
      <th>1169</th>
      <td>069920</td>
      <td>아이에스이커머스</td>
      <td>1.175583</td>
    </tr>
    <tr>
      <th>1346</th>
      <td>090710</td>
      <td>휴림로봇</td>
      <td>1.825243</td>
    </tr>
    <tr>
      <th>1456</th>
      <td>101730</td>
      <td>위메이드맥스</td>
      <td>1.966667</td>
    </tr>
    <tr>
      <th>1546</th>
      <td>121600</td>
      <td>나노신소재</td>
      <td>1.295129</td>
    </tr>
    <tr>
      <th>1583</th>
      <td>128540</td>
      <td>에코캡</td>
      <td>1.188023</td>
    </tr>
    <tr>
      <th>1608</th>
      <td>134580</td>
      <td>탑코미디어</td>
      <td>1.281567</td>
    </tr>
    <tr>
      <th>1945</th>
      <td>249420</td>
      <td>일동제약</td>
      <td>1.685065</td>
    </tr>
    <tr>
      <th>2033</th>
      <td>278650</td>
      <td>노터스</td>
      <td>1.331940</td>
    </tr>
    <tr>
      <th>2242</th>
      <td>373200</td>
      <td>하인크코리아</td>
      <td>2.129707</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank()</span></code> 함수를 통해 12개월 수익률 열의 순위를 구하며, 모멘텀의 경우 지표가 높을수록 좋으므로 <code class="docutils literal notranslate"><span class="pre">ascending</span> <span class="pre">=</span> <span class="pre">False</span></code> 인자를 통해 내림차순으로 순위를 구한다.</p></li>
<li><p>momentum_rank &lt;= 20 즉 모멘텀이 높은 20 종목을 선택한다.</p></li>
</ol>
<p>마지막으로 해당 종목들의 가격 그래프를 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_momentum</span> <span class="o">=</span> <span class="n">price_list</span><span class="p">[</span><span class="n">price_list</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
    <span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">momentum_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;종목코드&#39;</span><span class="p">])]</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">relplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">price_momentum</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;날짜&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;종가&#39;</span><span class="p">,</span>
                <span class="n">col</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
                <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span>
                <span class="n">facet_kws</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;sharey&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;sharex&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">})</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticklabels</span><span class="o">=</span><span class="p">[])</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_46_0.png" src="_images/factor_46_0.png" />
</div>
</div>
</div>
<div class="section" id="k-ratio">
<h3><span class="section-number">13.4.3. </span>K-Ratio<a class="headerlink" href="#k-ratio" title="Permalink to this headline">¶</a></h3>
<p>12개월 수익률 기준 모멘텀 종목들의 주가 그래프를 보면 단순히 수익률 만으로 종목을 선택할 경우 다음과 같은 종목 또한 포함된다.</p>
<ol class="simple">
<li><p>장기간 수익률이 횡보하다가 최근 주가가 급등하여 누적수익률 역시 높게 나타나는 종목</p></li>
<li><p>이미 몇달전에 주가가 급등한 후 최근에는 하락세이지만, 누적수익률 자체는 높게 나타나는 종목</p></li>
</ol>
<p>반면 좋은 모멘텀 주식이란 단순히 많이 상승한 것이 아닌, 꾸준하게 상승하는 종목이다. 하나의 예를 살펴보자.</p>
<div class="figure align-default" id="factor-k">
<img alt="_images/factor_k.png" src="_images/factor_k.png" />
<p class="caption"><span class="caption-number">Fig. 13.2 </span><span class="caption-text">모멘텀의 종류</span><a class="headerlink" href="#factor-k" title="Permalink to this image">¶</a></p>
</div>
<p>동일한 누적수익률을 가진 두 종목이 있다고 가정해보자. A의 경우 상승폭이 작다가 최근 급등하여 누적수익률이 높아진 경우다. 반면 B의 경우 꾸준하게 상승하여 누적수익률이 높아진 경우다. 이 중 꾸준하게 상승한 B가 더 뛰어난 모멘텀 주식이라고 볼 수 있다. 이처럼 꾸준한 상승을 측정하기 위해 실무에서는 단순 12개월 수익률이 아닌 3~12개월 수익률을 같이 보거나, 변동성을 함께 고려하기도 한다. 그 중 모멘텀의 꾸준함을 측정하는 지표 중 하나가 ‘K-Ratio’다. 해당 지표는 다음과 같다.</p>
<div class="math notranslate nohighlight">
\[K-Ratio = \frac{누적수익률의\ 기울기}{표준\ 오차}\]</div>
<p>누적수익률이 높을수록 기울기도 커져 분자는 커진다. 또한 추세가 꾸준할수록 표준 오차가 작아 분자는 작아진다. 따라서 추세가 꾸준하게 많이 상승할수록 K-Ratio는 증가한다. 먼저 K-Ratio를 측정하는 법을 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">ret_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">ret_cum</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pct_change()</span></code> 함수를 통해 각 종목의 수익률을 계산하며, 수익률이 계산되지 않는 첫번째 행은 제외한다.</p></li>
<li><p>수익률에 1을 더한 후 로그를 취하고, 해당값의 누적합을 구한다. 결과적으로 로그 누적수익률을 계산한다.</p></li>
<li><p><span class="math notranslate nohighlight">\(x\)</span>축에는 기간에 해당하는 값을, <span class="math notranslate nohighlight">\(y\)</span>축에는 첫번째 종목의 로그 누적수익률에 해당하는 값을 입력한다.</p></li>
</ol>
<p>이제 해당 종목의 K-Ratio를 구해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">reg</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>            <td>y</td>        <th>  R-squared (uncentered):</th>      <td>   0.538</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared (uncentered):</th> <td>   0.537</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>          <td>   285.8</td>
</tr>
<tr>
  <th>Date:</th>             <td>Sat, 30 Jul 2022</td> <th>  Prob (F-statistic):</th>          <td>5.08e-43</td>
</tr>
<tr>
  <th>Time:</th>                 <td>14:56:31</td>     <th>  Log-Likelihood:    </th>          <td>  179.79</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>   246</td>      <th>  AIC:               </th>          <td>  -357.6</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>   245</td>      <th>  BIC:               </th>          <td>  -354.1</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     1</td>      <th>                     </th>              <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>              <td> </td>   
</tr>
</table>
<table class="simpletable">
<tr>
   <td></td>     <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>x1</th> <td>   -0.0009</td> <td> 5.26e-05</td> <td>  -16.907</td> <td> 0.000</td> <td>   -0.001</td> <td>   -0.001</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td> 6.289</td> <th>  Durbin-Watson:     </th> <td>   0.076</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.043</td> <th>  Jarque-Bera (JB):  </th> <td>   9.817</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.020</td> <th>  Prob(JB):          </th> <td> 0.00738</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 3.978</td> <th>  Cond. No.          </th> <td>    1.00</td>
</tr>
</table><br/><br/>Notes:<br/>[1] R² is computed without centering (uncentered) since the model does not contain a constant.<br/>[2] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OLS()</span></code> 함수를 통해 회귀분석을 실시한다. 결과표의 ‘coef’는 기울기를, ‘std err’는 표준 오차를 나타낸다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">bse</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">params</span> <span class="o">/</span> <span class="n">reg</span><span class="o">.</span><span class="n">bse</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.00088875] [5.25684748e-05] [-16.90656314]
</pre></div>
</div>
</div>
</div>
<p>[reg.params]과 [reg.bse]를 통해 기울기와 표준오차를 추출할 수 있으며, 이 두개를 나눈 값이 K-Ratio다. 이를 이용해 모든 종목의 K-Ratio를 계산한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
<span class="n">k_ratio</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticker_list</span><span class="p">)):</span>

    <span class="n">ticker</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;종목코드&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ret_cum</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">]</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">params</span> <span class="o">/</span> <span class="n">reg</span><span class="o">.</span><span class="n">bse</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">k_ratio</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

<span class="n">k_ratio_bind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">k_ratio</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">k_ratio_bind</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;K_ratio&#39;</span><span class="p">]</span>

<span class="n">k_ratio_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>K_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>-16.906563</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>-68.767035</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>10.528547</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>34.998428</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>-79.903455</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p><span class="math notranslate nohighlight">\(x\)</span> 축에 해당하는 값과, 빈 딕셔너리(k_ratio)를 만든다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">loop</span></code> 구문을 통해 모든 종목에 대한 K-Ratio를 구한다.</p></li>
<li><p>해당 종목이 상장한지 1년이 되지 않아 K-Ratio를 구할 수 없을 경우 <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">except</span></code> 구문을 통해 nan을 저장한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">from_dict()</span></code> 메서드를 통해 딕셔너리를 데이터프레임 형태로 변경한다.</p></li>
</ol>
<p>이제 K-Ratio가 높은 종목을 찾아보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">k_ratio_bind</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>
<span class="n">k_ratio_rank</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;K_ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data_bind</span><span class="p">[</span><span class="n">k_ratio_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>return</th>
      <th>K_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>51</th>
      <td>001070</td>
      <td>대한방직</td>
      <td>0.148402</td>
      <td>44.348785</td>
    </tr>
    <tr>
      <th>125</th>
      <td>002710</td>
      <td>TCC스틸</td>
      <td>1.242188</td>
      <td>58.103304</td>
    </tr>
    <tr>
      <th>147</th>
      <td>003100</td>
      <td>선광</td>
      <td>1.004260</td>
      <td>105.309070</td>
    </tr>
    <tr>
      <th>218</th>
      <td>004890</td>
      <td>동일산업</td>
      <td>0.706731</td>
      <td>60.835553</td>
    </tr>
    <tr>
      <th>225</th>
      <td>005010</td>
      <td>휴스틸</td>
      <td>0.398897</td>
      <td>37.148908</td>
    </tr>
    <tr>
      <th>314</th>
      <td>007660</td>
      <td>이수페타시스</td>
      <td>1.127788</td>
      <td>65.017367</td>
    </tr>
    <tr>
      <th>503</th>
      <td>016710</td>
      <td>대성홀딩스</td>
      <td>1.093385</td>
      <td>90.526952</td>
    </tr>
    <tr>
      <th>514</th>
      <td>017390</td>
      <td>서울가스</td>
      <td>0.724638</td>
      <td>71.006958</td>
    </tr>
    <tr>
      <th>974</th>
      <td>053050</td>
      <td>지에스이</td>
      <td>1.497512</td>
      <td>53.281509</td>
    </tr>
    <tr>
      <th>1000</th>
      <td>054210</td>
      <td>이랜텍</td>
      <td>1.617450</td>
      <td>86.856359</td>
    </tr>
    <tr>
      <th>1128</th>
      <td>066970</td>
      <td>엘앤에프</td>
      <td>1.001770</td>
      <td>42.384023</td>
    </tr>
    <tr>
      <th>1238</th>
      <td>079550</td>
      <td>LIG넥스원</td>
      <td>0.867125</td>
      <td>69.940901</td>
    </tr>
    <tr>
      <th>1395</th>
      <td>095340</td>
      <td>ISC</td>
      <td>0.415133</td>
      <td>41.562098</td>
    </tr>
    <tr>
      <th>1499</th>
      <td>109860</td>
      <td>동일금속</td>
      <td>0.774090</td>
      <td>76.588914</td>
    </tr>
    <tr>
      <th>1531</th>
      <td>117580</td>
      <td>대성에너지</td>
      <td>0.754250</td>
      <td>38.811400</td>
    </tr>
    <tr>
      <th>1546</th>
      <td>121600</td>
      <td>나노신소재</td>
      <td>1.295129</td>
      <td>58.489379</td>
    </tr>
    <tr>
      <th>1617</th>
      <td>137400</td>
      <td>피엔티</td>
      <td>0.595506</td>
      <td>46.261286</td>
    </tr>
    <tr>
      <th>1866</th>
      <td>222800</td>
      <td>심텍</td>
      <td>0.567134</td>
      <td>38.876950</td>
    </tr>
    <tr>
      <th>1900</th>
      <td>232680</td>
      <td>라온테크</td>
      <td>0.552991</td>
      <td>40.792540</td>
    </tr>
    <tr>
      <th>2211</th>
      <td>353200</td>
      <td>대덕전자</td>
      <td>0.778816</td>
      <td>72.401297</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>단순 모멘텀(12개월 수익률)과 동일하게 K-Ratio도 높을수록 좋으므로 내림차순 기준으로 순위를 구한다. 이제 해당 종목들의 가격 그래프를 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k_ratio_momentum</span> <span class="o">=</span> <span class="n">price_list</span><span class="p">[</span><span class="n">price_list</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k_ratio_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;종목코드&#39;</span><span class="p">])]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">relplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">k_ratio_momentum</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s1">&#39;날짜&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s1">&#39;종가&#39;</span><span class="p">,</span>
                <span class="n">col</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
                <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span>
                <span class="n">facet_kws</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;sharey&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;sharex&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">})</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xticklabels</span><span class="o">=</span><span class="p">[])</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_58_0.png" src="_images/factor_58_0.png" />
</div>
</div>
<p>기존 단순 모멘텀이 비해 훨씬 더 꾸준하게 우상향하는 종목들이 선택되었다.</p>
</div>
</div>
<div class="section" id="id11">
<h2><span class="section-number">13.5. </span>퀄리티 전략<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>벤자민 그레이엄 이후 유지되고 있는 기본적 분석 혹은 가치 투자자들의 가장 중요한 투자 지표 중 하나는 기업의 우량성(퀄리티)이다. 벤저민 그레이엄은 종목 선정에 있어 유동 자산이 풍부하여 재무적으로 건전하고, 꾸준하게 이익을 달성하는 기업을 강조했다. 최고의 투자자로 꼽히는 워런 버핏의 종목 선정 기준 역시 실적의 강력한 성장 추세와 높은 자기자본 이익률로 알려져 있습니다.</p>
<p>그러나 어떠한 지표가 기업의 우량성을 나타내는지 한 마디로 정의하기에는 너무나 주관적이고 광범위해 쉽지 않다. 애스니스는 연구를 통해 수익성, 성장성, 안정성이 높을 주식일수록 수익률이 높은 경향이 있음을 보였다. 이 외에도 학계 혹은 업계에서 사용되는 우량성 관련 지표는 다음과 같이 요약할 수 있다.</p>
<ol class="simple">
<li><p>수익성: 기업이 돈을 얼마나 잘 버는가(ROE, ROA, 매출총이익률 등).</p></li>
<li><p>수익의 안정성: 기업이 얼마나 안정적으로 돈을 버는가(ROE의 변동성 등).</p></li>
<li><p>재무 구조: 기업의 재무 구조가 얼마나 안전한가(차입비율 등).</p></li>
<li><p>이익의 성장: 기업의 이익 증가율이 얼마나 되는가(전년 대비 ROE 증가율 등).</p></li>
<li><p>재무 신뢰도: 재무제표를 얼마나 신뢰할 수 있는가(회계 처리 방법 등).
6 배당: 얼마나 주주 친화적인가(배당금, 신주발행, 자사주 매입 등.)
7 투자: 얼마나 신사업에 투자를 하는가(총자산의 증가 등)</p></li>
</ol>
<p>이 중 사람들이 가장 중요하게 여기는 것은 바로 수익성이다. 돈을 벌지 못하는 기업은 지속될 수 없기 때문이다. 기업의 규모가 크면 당연히 돈을 더 많이 벌기 때문에 단순히 수익의 양이 아닌, 기업의 규모에 비해 얼마를 버는지 표준화를 통해 비교해야 한다. <a class="reference internal" href="#quality-table"><span class="std std-numref">Table 13.4</span></a>는 널리 사용되고 있는 수익성 지표들이다.</p>
<table class="colwidths-auto table" id="quality-table">
<caption><span class="caption-number">Table 13.4 </span><span class="caption-text">수익성 지표</span><a class="headerlink" href="#quality-table" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>지표</p></th>
<th class="head"><p>설명</p></th>
<th class="head"><p>분자</p></th>
<th class="head"><p>분모</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ROE(Return on Equity)</p></td>
<td><p>자기자본이익율</p></td>
<td><p>당기순이익</p></td>
<td><p>자본</p></td>
</tr>
<tr class="row-odd"><td><p>ROE(Return on Asset)</p></td>
<td><p>총자산이익률</p></td>
<td><p>당기순이익</p></td>
<td><p>자산</p></td>
</tr>
<tr class="row-even"><td><p>ROIC(Return on Invested Capital)</p></td>
<td><p>투하자본이익률</p></td>
<td><p>당기순이익</p></td>
<td><p>투하자본</p></td>
</tr>
<tr class="row-odd"><td><p>GP(Gross Profitability)</p></td>
<td><p>매출총이익률</p></td>
<td><p>매출총이익</p></td>
<td><p>자산 혹은 자본</p></td>
</tr>
</tbody>
</table>
<p>우량주 효과가 발생하는 이유 역시 사람들의 반응과 관계가 있다. 기업의 수익성이 높을 경우, 투자자들은 이익이 다시 원래 수준으로 빠르게 돌아갈 것이라 생각하지만, 실제로는 수익성이 높은 기업은 계속해서 높은 수익성을 보이는 경향이 있다. 반대로 기업의 수익성이 낮은 경우, 투자자들은 이익이 반등할 것이라 생각하지만 나쁜 기업은 계속해서 나쁜 경향이 있다.</p>
<div class="section" id="id12">
<h3><span class="section-number">13.5.1. </span>수익성별 포트폴리오의 수익률<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>영업수익성을 기준으로 구성된 포트폴리오의 수익률을 비교해보겠다. 프렌치 라이브러이에서 해당 데이터의 이름은 ‘Portfolios_Formed_on_OP’ 이다. 단, 수익성 항목이 들어간 데이터들의 경우 <code class="docutils literal notranslate"><span class="pre">pandas_datareader</span></code> 패키지에서 불러올 경우 인코딩 문제로 인해 오류가 발생하므로, 홈페이지에서 직접 파일을 다운로드 받도록 한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/Portfolios_Formed_on_OP_CSV.zip&#39;</span>
<span class="n">df_op</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;cp1252&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">end_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_op</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df_op_vw</span> <span class="o">=</span> <span class="n">df_op</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end_point</span><span class="p">][[</span>
    <span class="s1">&#39;Lo 20&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 2&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 3&#39;</span><span class="p">,</span> <span class="s1">&#39;Qnt 4&#39;</span><span class="p">,</span> <span class="s1">&#39;Hi 20&#39;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>
<span class="n">df_op_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_op_vw</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">unicode_minus</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df_op_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
               <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
               <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;수익성별 포트폴리오의 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_60_0.png" src="_images/factor_60_0.png" />
</div>
</div>
<ol class="simple">
<li><p>zip 파일 링크를 입력한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read_csv()</span></code> 함수 내에 zip 파일 링크를 입력하면, 압축 파일 내의 CSV 파일을 불러올 수 있다. 또한 상위 행 24개는 데이터에 대한 설명이므로 <code class="docutils literal notranslate"><span class="pre">skiprows</span></code> 인자를 통해 무시해주며, 인코딩은 cp1252로, 인덱스는 첫번째 열로 설정한다.</p></li>
<li><p>파일 내에는 월별 수익률, 연간 수익률, 포트폴리오 내 종목수 등 수많은 테이블이 포함되어 있다. 이 중 시가총액가중방식 포트폴리오에 해당하는 부분만 찾기 위해 <code class="docutils literal notranslate"><span class="pre">isna()</span></code> 함수를 통해 처음으로 na가 나타나는 지점(end_point)을 찾는다.</p></li>
<li><p>시가총액가중방식 수익률에 해당하는 부분만 선택하며, 20%씩 나눈 열을 선택한다. 그 후 <code class="docutils literal notranslate"><span class="pre">apply(pd.to_numeric)</span></code> 를 통해 모든 열을 숫자 형태로 변경한다.</p></li>
<li><p>로그 누적수익률을 계산한다.</p></li>
</ol>
<p>누적수익률을 확인해보면, 수익성이 높을수록(Hi 20) 향후에도 지속적으로 수익률이 높으며, 수익성이 낮을수록(Lo 20) 향후에도 수익률이 낮은 ‘퀄리티 현상’이 존재한다. 이번에는 포트폴리오 별 통계값을 확인해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">factor_stat</span><span class="p">(</span><span class="n">df_op_vw</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Lo 20</th>
      <th>Qnt 2</th>
      <th>Qnt 3</th>
      <th>Qnt 4</th>
      <th>Hi 20</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>연율화 수익률(산술)</th>
      <td>8.9900</td>
      <td>10.2100</td>
      <td>11.3900</td>
      <td>11.3900</td>
      <td>12.2800</td>
    </tr>
    <tr>
      <th>연율화 수익률(기하)</th>
      <td>7.2800</td>
      <td>9.2900</td>
      <td>10.6800</td>
      <td>10.7000</td>
      <td>11.6600</td>
    </tr>
    <tr>
      <th>연율화 변동성</th>
      <td>19.5000</td>
      <td>16.0300</td>
      <td>15.3800</td>
      <td>15.3200</td>
      <td>15.4600</td>
    </tr>
    <tr>
      <th>샤프지수</th>
      <td>0.4612</td>
      <td>0.6372</td>
      <td>0.7403</td>
      <td>0.7431</td>
      <td>0.7942</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>수익성이 높을수록 수익률이 높고 변동성이 낮음을 확인할 수 있다.</p>
</div>
<div class="section" id="id13">
<h3><span class="section-number">13.5.2. </span>우량성 포트폴리오 구하기<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>이번에는 국내 종목들 중 우량성(수익성)이 높은 종믁은 어떠한 것이 있는지 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_ticker</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="s2">and 종목구분 = &#39;보통주&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">fs_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_fs</span>
<span class="s2">where 계정 in (&#39;당기순이익&#39;, &#39;매출총이익&#39;, &#39;영업활동으로인한현금흐름&#39;, &#39;자산&#39;, &#39;자본&#39;)</span>
<span class="s2">and 공시구분 = &#39;q&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>먼저 DB에서 티커 테이블과 재무제표 테이블 중 수익성을 계산하는데 필요한 계정(당기순이익, 매출총이익, 영업활동으로으로인한현금흐름, 자산, 자본 / 분기 데이터)을 불러온다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="s1">&#39;기준일&#39;</span><span class="p">])</span>
<span class="n">fs_list</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span>
<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;계정&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;자산&#39;</span><span class="p">,</span> <span class="s1">&#39;자본&#39;</span><span class="p">]),</span>
                                <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">])</span>
<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fs_list_pivot</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;ttm&#39;</span><span class="p">)</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;ROE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;당기순이익&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자본&#39;</span><span class="p">]</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;GPA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;매출총이익&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자산&#39;</span><span class="p">]</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;CFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;영업활동으로인한현금흐름&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자산&#39;</span><span class="p">]</span>

<span class="n">quality_list</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fs_list_pivot</span><span class="p">,</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                  <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>
<span class="n">quality_list</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>당기순이익</th>
      <th>매출총이익</th>
      <th>영업활동으로인한현금흐름</th>
      <th>자본</th>
      <th>자산</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>198.0</td>
      <td>1582.0</td>
      <td>438.0</td>
      <td>3561.25</td>
      <td>4507.00</td>
      <td>0.0556</td>
      <td>0.3510</td>
      <td>0.0972</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>-130.0</td>
      <td>181.0</td>
      <td>-86.0</td>
      <td>503.25</td>
      <td>1727.50</td>
      <td>-0.2583</td>
      <td>0.1048</td>
      <td>-0.0498</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>306.0</td>
      <td>1440.0</td>
      <td>359.0</td>
      <td>7550.75</td>
      <td>12790.00</td>
      <td>0.0405</td>
      <td>0.1126</td>
      <td>0.0281</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>7441.0</td>
      <td>NaN</td>
      <td>11081.0</td>
      <td>22177.50</td>
      <td>271524.00</td>
      <td>0.3355</td>
      <td>NaN</td>
      <td>0.0408</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>2384.0</td>
      <td>7047.0</td>
      <td>2021.0</td>
      <td>24182.25</td>
      <td>44074.75</td>
      <td>0.0986</td>
      <td>0.1599</td>
      <td>0.0459</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sort_values()</span></code> 메서드를 통해 정렬을 한다.</p></li>
<li><p>‘종목코드’와 ‘계정’ 별로 그룹을 묶은 후 TTM 값을 구하기 위해 <code class="docutils literal notranslate"><span class="pre">rolling()</span></code> 메서드를 통해 4분기 합을 구한다., 4분기 데이터가 없는 경우는 계산하지 않는다.</p></li>
<li><p>자산과 자본의 경우 재무상태표 항목이므로 평균을 구하며, 나머지 항목은 그대로 사용한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tail(1)</span></code>을 통해 종목코드와 계정 별 최근 데이터만 선택한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pivot()</span></code> 함수를 통해 가로로 긴 형태로 변경한다.</p></li>
<li><p>수익성 지표에 해당하는 ROE, GPA, CFO를 각각 구한다.</p></li>
<li><p>티커 테이블과 합쳐준다.</p></li>
</ol>
<p>이제 각 수익성 지표의 순위를 구한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quality_list_copy</span> <span class="o">=</span> <span class="n">quality_list</span><span class="p">[[</span><span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span> <span class="s1">&#39;CFO&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">quality_rank</span> <span class="o">=</span> <span class="n">quality_list_copy</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>수익성 지표의 경우 값이 높을수록 좋으므로 <code class="docutils literal notranslate"><span class="pre">ascending</span> <span class="pre">=</span> <span class="pre">False</span></code>를 통해 내림차순 기준 순위를 구한다. 각 지표 별 상관관계를 살펴보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">quality_rank</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">quality_rank</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_70_0.png" src="_images/factor_70_0.png" />
</div>
</div>
<p>비슷한 수익성 지표임에도 불구하고 서로 간의 상관관계가 꽤 낮다. 따라서 지표를 통합적으로 고려하면 분산효과를 기대할 수 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quality_sum</span> <span class="o">=</span> <span class="n">quality_rank</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
<span class="n">quality_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">quality_sum</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span>
                 <span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">,</span> <span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span> <span class="s1">&#39;CFO&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>46</th>
      <td>000990</td>
      <td>DB하이텍</td>
      <td>0.4055</td>
      <td>0.4520</td>
      <td>0.2979</td>
    </tr>
    <tr>
      <th>407</th>
      <td>011200</td>
      <td>HMM</td>
      <td>0.9067</td>
      <td>0.5889</td>
      <td>0.5699</td>
    </tr>
    <tr>
      <th>1038</th>
      <td>058630</td>
      <td>엠게임</td>
      <td>0.3126</td>
      <td>0.7389</td>
      <td>0.2155</td>
    </tr>
    <tr>
      <th>1133</th>
      <td>067160</td>
      <td>아프리카TV</td>
      <td>0.3782</td>
      <td>0.7456</td>
      <td>0.3509</td>
    </tr>
    <tr>
      <th>1283</th>
      <td>084650</td>
      <td>랩지노믹스</td>
      <td>0.7156</td>
      <td>0.8150</td>
      <td>0.2906</td>
    </tr>
    <tr>
      <th>1335</th>
      <td>089970</td>
      <td>에이피티씨</td>
      <td>0.3756</td>
      <td>0.4857</td>
      <td>0.4497</td>
    </tr>
    <tr>
      <th>1406</th>
      <td>096530</td>
      <td>씨젠</td>
      <td>0.5233</td>
      <td>0.7301</td>
      <td>0.4055</td>
    </tr>
    <tr>
      <th>1489</th>
      <td>108320</td>
      <td>LX세미콘</td>
      <td>0.4598</td>
      <td>0.6625</td>
      <td>0.3586</td>
    </tr>
    <tr>
      <th>1616</th>
      <td>137310</td>
      <td>에스디바이오센서</td>
      <td>0.5246</td>
      <td>0.5600</td>
      <td>0.3779</td>
    </tr>
    <tr>
      <th>1665</th>
      <td>150900</td>
      <td>파수</td>
      <td>0.2609</td>
      <td>0.6655</td>
      <td>0.3823</td>
    </tr>
    <tr>
      <th>1757</th>
      <td>194480</td>
      <td>데브시스터즈</td>
      <td>0.3083</td>
      <td>1.3381</td>
      <td>0.2407</td>
    </tr>
    <tr>
      <th>1793</th>
      <td>205470</td>
      <td>휴마시스</td>
      <td>1.6078</td>
      <td>1.4010</td>
      <td>1.1184</td>
    </tr>
    <tr>
      <th>1830</th>
      <td>215000</td>
      <td>골프존</td>
      <td>0.3250</td>
      <td>0.6746</td>
      <td>0.3084</td>
    </tr>
    <tr>
      <th>1833</th>
      <td>215200</td>
      <td>메가스터디교육</td>
      <td>0.2664</td>
      <td>0.6105</td>
      <td>0.2788</td>
    </tr>
    <tr>
      <th>1873</th>
      <td>225190</td>
      <td>삼양옵틱스</td>
      <td>0.3365</td>
      <td>0.5404</td>
      <td>0.3173</td>
    </tr>
    <tr>
      <th>1874</th>
      <td>225220</td>
      <td>제놀루션</td>
      <td>0.4199</td>
      <td>0.5523</td>
      <td>0.2622</td>
    </tr>
    <tr>
      <th>1958</th>
      <td>253840</td>
      <td>수젠텍</td>
      <td>0.6624</td>
      <td>0.6154</td>
      <td>0.2457</td>
    </tr>
    <tr>
      <th>2047</th>
      <td>287410</td>
      <td>제이시스메디칼</td>
      <td>0.6294</td>
      <td>0.9214</td>
      <td>0.3265</td>
    </tr>
    <tr>
      <th>2199</th>
      <td>348210</td>
      <td>넥스틴</td>
      <td>0.3430</td>
      <td>0.5315</td>
      <td>0.2658</td>
    </tr>
    <tr>
      <th>2264</th>
      <td>383220</td>
      <td>F&amp;F</td>
      <td>0.7232</td>
      <td>1.0955</td>
      <td>0.4564</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>위에서 구한 세개 지표들의 순위를 더한 후 다시 순위를 매긴다.</p></li>
<li><p>최종 순위가 낮은 20 종목을 선택한다. 즉 하나의 지표보다 세개 지표가 골고루 낮은 종목을 선택한다.</p></li>
</ol>
</div>
</div>
<div class="section" id="id14">
<h2><span class="section-number">13.6. </span>마법공식<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p>하나의 팩터만을 보고 투자하는 것보다, 둘 혹은 그 이상의 팩터를 결합해 투자해야 훨씬 좋은 포트폴리오를 구성할 수 있으며, 이러한 방법을 멀티팩터라고 한다. 그중에서도 밸류와 퀄리티의 조합은 전통적으로 많이 사용된 방법이며, 대표적인 예가 조엘 그린블라트의 ‘마법공식’이다. 이에 앞서, 퀄리티와 밸류 간의 관계, 마법공식의 정의와 구성 방법을 알아보겠다.</p>
<div class="section" id="id15">
<h3><span class="section-number">13.6.1. </span>퀄리티와 밸류 간의 관계<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>투자의 정석 중 하나는 좋은 기업을 싸게 사는 것이다. 이를 팩터의 관점에서 이해하면 퀄리티 팩터와 밸류 팩터로 이해할 수도 있다.</p>
<p>여러 논문에 따르면 흔히 밸류 팩터와 퀄리티 팩터는 반대의 관계에 있다. 먼저 가치주들은 위험이 크기 때문에 시장에서 소외를 받아 저평가가 이루어지는 것이며, 이러한 위험에 대한 대가로 밸류 팩터의 수익률이 높다. 반대로 사람들은 우량주에 기꺼이 프리미엄을 지불하려 하기 때문에 퀄리티 팩터의 수익률이 높기도 하다. 이는 마치 동전의 양면과 같지만, 장기적으로 가치주와 우량주 모두 우수한 성과를 기록한다. 먼저 퀄리티의 지표인 매출총이익과 밸류 지표인 PBR을 통해 둘 사이의 관계를 확인해 보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">value_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_value</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_value)</span>
<span class="s2">and 지표 = &#39;PBR&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">fs_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_fs</span>
<span class="s2">where 계정 in (&#39;매출총이익&#39;, &#39;자산&#39;)</span>
<span class="s2">and 공시구분 = &#39;y&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<span class="c1"># 밸류 지표</span>
<span class="n">value_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_list</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">value_pivot</span> <span class="o">=</span> <span class="n">value_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;지표&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;값&#39;</span><span class="p">)</span>

<span class="c1"># 퀄리티 지표</span>
<span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="s1">&#39;기준일&#39;</span><span class="p">])</span>
<span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fs_list_pivot</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;값&#39;</span><span class="p">)</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;GPA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;매출총이익&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자산&#39;</span><span class="p">]</span>

<span class="c1"># 데이터 합치기</span>
<span class="n">bind_rank</span> <span class="o">=</span> <span class="n">value_pivot</span><span class="p">[</span><span class="s1">&#39;PBR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;GPA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>

<span class="c1"># 상관관계</span>
<span class="n">bind_rank</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PBR</th>
      <th>GPA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PBR</th>
      <td>1.000000</td>
      <td>-0.123318</td>
    </tr>
    <tr>
      <th>GPA</th>
      <td>-0.123318</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>DB에서 밸류 테이블과 재무제표 테이블 중 매출총이익, 자산 항목(연간 재무제표 기준)을 불러온다.</p></li>
<li><p>밸류 지표가 음수인 경우 nan으로 변환한 후, 피벗을 한다.</p></li>
<li><p>재무제표 데이터 중 가장 최근 데이터를 이용해 매출총이익률을 구한다.</p></li>
<li><p>두 지표의 순위를 각각 구한 후 <code class="docutils literal notranslate"><span class="pre">merge()</span></code> 함수를 통해 하나로 합친다. 매출총이익률의 경우 내림차순으로 순위를 구한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">corr()</span></code> 함수를 통해 순위의 상관관계를 구한다.</p></li>
</ol>
<p>PBR과 GPA 간에는 음의 상관관계가 있음이 확인된다. 이번에는 PBR의 분위수별 GPA 평균값을 구해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">bind_data</span> <span class="o">=</span> <span class="n">value_list</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fs_list_pivot</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>
<span class="n">bind_data</span> <span class="o">=</span> <span class="n">bind_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">bind_data</span><span class="p">[</span><span class="s1">&#39;PBR_quantile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">bind_data</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">bind_group</span> <span class="o">=</span> <span class="n">bind_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;PBR_quantile&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;GPA&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">height</span><span class="o">=</span><span class="n">bind_group</span><span class="p">[</span><span class="s1">&#39;GPA&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PBR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;GPA&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_76_0.png" src="_images/factor_76_0.png" />
</div>
</div>
<ol class="simple">
<li><p>밸류와 재무제표 테이블을 하나로 합친다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dropna()</span></code>를 통해 NA가 있는 데이터는 제거한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qcut()</span></code> 함수를 이용해 PBR을 5분위수로 나누어준다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">groupby()</span></code> 함수를 통해 PBR의 분위수별 그룹을 묶어 준 후, 각 그룹별 GPA의 평균값을 구한다.</p></li>
<li><p>그래프로 나타낸다.</p></li>
</ol>
<p>그림에서 알 수 있듯이 PBR이 낮을수록 GPA도 낮으며, 즉 가치주일수록 우량성은 떨어진다. 반면에 PBR이 높을수록 GPA도 높으며, 이는 주식의 가격이 비쌀수록 우량성도 높다는 뜻이다. 이를 이용해 밸류 팩터와 퀄리티 팩터 간의 관계를 나타내면 다음과 같다.</p>
<div class="figure align-default" id="tableqv">
<img alt="_images/tableqv.png" src="_images/tableqv.png" />
<p class="caption"><span class="caption-number">Fig. 13.3 </span><span class="caption-text">밸류 팩터와 퀄리티 팩터간의 관계</span><a class="headerlink" href="#tableqv" title="Permalink to this image">¶</a></p>
</div>
<p>주가가 쌀수록 기업의 우량성은 떨어지며(①번), 반대로 기업의 우량성이 좋으면 주식은 비싼 경향(③번)이 있다. 물론 우량성도 떨어지고 비싸기만한 주식(②번)을 사려는 사람들 아마 없을 겁이. 결과적으로 우리가 원하는 최고의 주식은 우량성이 있으면서도 가격은 싼 주식(④번)이다. 프렌치 라이브러리의 데이터를 이용해 4개 포트폴리오의 수익률 차이를 확인해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/25_Portfolios_BEME_OP_5x5_CSV.zip&#39;</span>
<span class="n">df_qv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;cp1252&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">end_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">df_qv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df_qv</span> <span class="o">=</span> <span class="n">df_qv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">end_point</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>

<span class="n">df_qv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LoBM LoOP</th>
      <th>BM1 OP2</th>
      <th>BM1 OP3</th>
      <th>BM1 OP4</th>
      <th>LoBM HiOP</th>
      <th>BM2 OP1</th>
      <th>BM2 OP2</th>
      <th>BM2 OP3</th>
      <th>BM2 OP4</th>
      <th>BM2 OP5</th>
      <th>...</th>
      <th>BM4 OP1</th>
      <th>BM4 OP2</th>
      <th>BM4 OP3</th>
      <th>BM4 OP4</th>
      <th>BM4 OP5</th>
      <th>HiBM LoOP</th>
      <th>BM5 OP2</th>
      <th>BM5 OP3</th>
      <th>BM5 OP4</th>
      <th>HiBM HiOP</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>196307</th>
      <td>1.5667</td>
      <td>2.3959</td>
      <td>0.1563</td>
      <td>-1.2606</td>
      <td>0.6103</td>
      <td>0.9993</td>
      <td>1.3035</td>
      <td>0.2018</td>
      <td>-0.6785</td>
      <td>-1.7133</td>
      <td>...</td>
      <td>-1.7649</td>
      <td>-0.2315</td>
      <td>-5.2519</td>
      <td>1.2625</td>
      <td>2.4473</td>
      <td>-2.0068</td>
      <td>1.4799</td>
      <td>2.3818</td>
      <td>-1.7646</td>
      <td>-1.0694</td>
    </tr>
    <tr>
      <th>196308</th>
      <td>5.9311</td>
      <td>2.5545</td>
      <td>6.4142</td>
      <td>5.5784</td>
      <td>5.8709</td>
      <td>1.5049</td>
      <td>3.8605</td>
      <td>4.5227</td>
      <td>5.0715</td>
      <td>5.8196</td>
      <td>...</td>
      <td>7.9667</td>
      <td>6.3687</td>
      <td>15.6138</td>
      <td>4.1357</td>
      <td>11.9795</td>
      <td>5.5811</td>
      <td>5.4168</td>
      <td>2.7514</td>
      <td>6.3988</td>
      <td>3.4264</td>
    </tr>
    <tr>
      <th>196309</th>
      <td>-5.0591</td>
      <td>-4.6972</td>
      <td>1.3918</td>
      <td>-1.8821</td>
      <td>-1.2090</td>
      <td>-2.0466</td>
      <td>-3.4478</td>
      <td>0.5906</td>
      <td>-2.3127</td>
      <td>-4.7340</td>
      <td>...</td>
      <td>-1.5994</td>
      <td>-0.3443</td>
      <td>3.7048</td>
      <td>-1.3282</td>
      <td>-8.4785</td>
      <td>-2.6077</td>
      <td>-4.7089</td>
      <td>-0.3835</td>
      <td>-0.4710</td>
      <td>-2.9148</td>
    </tr>
    <tr>
      <th>196310</th>
      <td>-2.1803</td>
      <td>-3.7151</td>
      <td>0.8348</td>
      <td>3.9774</td>
      <td>7.2644</td>
      <td>-0.5754</td>
      <td>1.9820</td>
      <td>2.5652</td>
      <td>-0.9068</td>
      <td>2.6782</td>
      <td>...</td>
      <td>2.8179</td>
      <td>0.5102</td>
      <td>9.8940</td>
      <td>6.6686</td>
      <td>18.9219</td>
      <td>1.2333</td>
      <td>2.5739</td>
      <td>2.0845</td>
      <td>-2.1846</td>
      <td>8.5136</td>
    </tr>
    <tr>
      <th>196311</th>
      <td>-3.1118</td>
      <td>0.0362</td>
      <td>-0.9976</td>
      <td>1.0218</td>
      <td>-2.6709</td>
      <td>-5.2223</td>
      <td>0.4643</td>
      <td>2.0600</td>
      <td>-1.0086</td>
      <td>-1.9512</td>
      <td>...</td>
      <td>0.3664</td>
      <td>-1.8246</td>
      <td>-4.4502</td>
      <td>0.9625</td>
      <td>5.1808</td>
      <td>1.0473</td>
      <td>-2.4117</td>
      <td>-1.6163</td>
      <td>-0.4706</td>
      <td>-2.8375</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 25 columns</p>
</div></div></div>
</div>
<p>‘25_Portfolios_BEME_OP_5x5’에 해당하는 데이터를 받아보면 밸류와 퀄리티 기준 각각 5분위로 나누어진 총 25개의 포트폴리오가 존재한다. 하나의 포트폴리오로 수익률을 살펴보기에는 포트폴리오 내 구성종목수가 너무 작으므로, 여러 포트폴리오의 평균을 통해 최종 포트폴리오를 구해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_qv_quality</span> <span class="o">=</span> <span class="n">df_qv</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;LoBM HiOP&#39;</span><span class="p">,</span> <span class="s1">&#39;BM2 OP5&#39;</span><span class="p">,</span> <span class="s1">&#39;BM3 OP5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Quality</span>
<span class="n">df_qv_value</span> <span class="o">=</span> <span class="n">df_qv</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;HiBM LoOP&#39;</span><span class="p">,</span> <span class="s1">&#39;BM5 OP2&#39;</span><span class="p">,</span> <span class="s1">&#39;BM5 OP3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Value</span>
<span class="n">df_qv_worst</span> <span class="o">=</span> <span class="n">df_qv</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;LoBM LoOP&#39;</span><span class="p">,</span> <span class="s1">&#39;BM1 OP2&#39;</span><span class="p">,</span> <span class="s1">&#39;BM2 OP1&#39;</span><span class="p">,</span> <span class="s1">&#39;BM2 OP2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Worst</span>
<span class="n">df_qv_best</span> <span class="o">=</span> <span class="n">df_qv</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;BM5 OP4&#39;</span><span class="p">,</span> <span class="s1">&#39;HiBM HiOP&#39;</span><span class="p">,</span> <span class="s1">&#39;BM4 OP4&#39;</span><span class="p">,</span> <span class="s1">&#39;BM4 OP5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Best</span>
<span class="n">df_qv_bind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_qv_quality</span><span class="p">,</span> <span class="n">df_qv_value</span><span class="p">,</span> <span class="n">df_qv_worst</span><span class="p">,</span> <span class="n">df_qv_best</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_qv_bind</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Quality&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="s1">&#39;Worst&#39;</span><span class="p">,</span> <span class="s1">&#39;Best&#39;</span><span class="p">]</span>
<span class="n">df_qv_bind_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_qv_bind</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">df_qv_bind_cum</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                    <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span>
                    <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;reverse&#39;</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;퀄리티/밸류별 누적 수익률&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_80_0.png" src="_images/factor_80_0.png" />
</div>
</div>
<p>아래의 기준별로 포트폴리오를 선택한 후 수익률의 평균을 구한다.</p>
<ul class="simple">
<li><p>Quality: 밸류 기준 하위 1, 2, 3분위에서 수익성 상위 1분위 (높은 퀄리티/높은 밸류에이션)</p></li>
<li><p>Value: 밸류 기준 상위 1분위에서 수익성 하위 1, 2, 3분위 (낮은 밸류에이션/낮은 퀄리티)</p></li>
<li><p>Worst: 밸류 기준 하위 1, 2분위에서 수익성 하위 1, 2분위(높은 밸류에이션/낮은 퀄리티)</p></li>
<li><p>Best: 밸류 기준 상위 1, 2분위에서 수익성 상위 1, 2분위(낮은 밸류에이션/높은 퀄리티)</p></li>
</ul>
<p>결과를 살펴보면 Worst 포트폴리오의 수익률이 가장 낮다. 밸류와 퀄리티는 비슷하게 좋은 모습을 보이며, 두 가지 팩터를 동시에 고려할 경우 가장 높은 수익률을 보인다.</p>
</div>
<div class="section" id="id16">
<h3><span class="section-number">13.6.2. </span>마법공식 이해하기<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<p>마법공식이란 고담 캐피탈의 설립자이자 전설적인 투자자 조엘 그린블라트에 의해 알려진 투자 방법이다. 그는 본인의 책 《주식 시장을 이기는 작은 책》에서 투자를 하는데 있어 중요한 두 가지 지표가 있으며, 이를 혼합하면 뛰어난 성과를 기록할 수 있다고 말했다.</p>
<p>첫 번째 지표는 ‘이익 수익률(Earnings Yield)’ 로써 기업의 수익을 기업의 가치로 나는 값이다. 이는 PER의 역수와 비슷하며, 밸류 지표 중 하나이다. 두 번째 지표는 ‘투하자본 수익률(Return on Capital)’ 로써 기업의 수익을 투자한 자본으로 나눈 값이다. 이는 ROE와도 비슷하며, 퀄리티 지표 중 하나이다. 마법공식은 이 두 가지 지표의 순위를 각각 구한 후 순위의 합 기준 상위 30~50개 종목을 1년간 보유한 후 매도하는 전략이다.</p>
<p>해당 전략은 국내 투자자들에게도 많이 사랑받는 전략이지만 두 지표를 계산하기 위한 데이터를 수집하기 어려워 많은 투자자들이 이율 대신 PER를 사용하고, 투하자본 수익률 대신 ROE를 사용한다. 그러나 우리가 수집한 데이터를 통해 충분히 원래의 마법공식을 구현할 수 있다.</p>
<table class="colwidths-auto table" id="magic-formula">
<caption><span class="caption-number">Table 13.5 </span><span class="caption-text">마법공식의 구성 요소</span><a class="headerlink" href="#magic-formula" title="Permalink to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>팩터</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Quality</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>지표</p></td>
<td><p>이익 수익률 (Earnings Yield)</p></td>
<td><p>투하자본 수익률 (Return On Capital)</p></td>
</tr>
<tr class="row-odd"><td><p>계산</p></td>
<td><p><span class="math notranslate nohighlight">\(\frac{이자\ 및\ 법인세\ 차감전이익}{기업\ 가치}\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(\frac{이자\ 및\ 법인세\ 차감전이익}{투하\ 자본}\)</span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id17">
<h3><span class="section-number">13.6.3. </span>마법공식 포트폴리오<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<p>재무제표 항목을 통해 이율과 투하자본 수익률을 계산하고, 이를 통해 마법공식 포트폴리오를 구성해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_ticker</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="s2">and 종목구분 = &#39;보통주&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">fs_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_fs</span>
<span class="s2">where 계정 in (&#39;매출액&#39;, &#39;당기순이익&#39;, &#39;법인세비용&#39;, &#39;이자비용&#39;, &#39;현금및현금성자산&#39;,</span>
<span class="s2">&#39;부채&#39;, &#39;유동부채&#39;, &#39;유동자산&#39;, &#39;비유동자산&#39;, &#39;감가상각비&#39;)</span>
<span class="s2">and 공시구분 = &#39;q&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="s1">&#39;기준일&#39;</span><span class="p">])</span>
<span class="n">fs_list</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span>
<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;계정&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;부채&#39;</span><span class="p">,</span> <span class="s1">&#39;유동부채&#39;</span><span class="p">,</span> <span class="s1">&#39;유동자산&#39;</span><span class="p">,</span> <span class="s1">&#39;비유동자산&#39;</span><span class="p">]),</span>
    <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">])</span>

<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fs_list_pivot</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;ttm&#39;</span><span class="p">)</span>

<span class="n">data_bind</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">,</span> <span class="s1">&#39;시가총액&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fs_list_pivot</span><span class="p">,</span>
                                                       <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                       <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>
<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;시가총액&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;시가총액&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100000000</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>시가총액</th>
      <th>감가상각비</th>
      <th>당기순이익</th>
      <th>매출액</th>
      <th>법인세비용</th>
      <th>부채</th>
      <th>비유동자산</th>
      <th>유동부채</th>
      <th>유동자산</th>
      <th>이자비용</th>
      <th>현금및현금성자산</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>3016.600</td>
      <td>107.0</td>
      <td>198.0</td>
      <td>3065.0</td>
      <td>66.0</td>
      <td>945.25</td>
      <td>2271.00</td>
      <td>686.00</td>
      <td>2235.75</td>
      <td>4.0</td>
      <td>2152.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>714.303</td>
      <td>33.0</td>
      <td>-130.0</td>
      <td>1400.0</td>
      <td>NaN</td>
      <td>1224.00</td>
      <td>1020.25</td>
      <td>995.00</td>
      <td>707.50</td>
      <td>69.0</td>
      <td>902.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>3509.150</td>
      <td>406.0</td>
      <td>306.0</td>
      <td>3976.0</td>
      <td>72.0</td>
      <td>5239.50</td>
      <td>11511.00</td>
      <td>2507.25</td>
      <td>1279.25</td>
      <td>42.0</td>
      <td>798.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>38369.500</td>
      <td>NaN</td>
      <td>7441.0</td>
      <td>NaN</td>
      <td>2866.0</td>
      <td>249346.25</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>406.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>6183.400</td>
      <td>NaN</td>
      <td>2384.0</td>
      <td>32289.0</td>
      <td>786.0</td>
      <td>19892.75</td>
      <td>27118.50</td>
      <td>9580.25</td>
      <td>16956.50</td>
      <td>276.0</td>
      <td>8312.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>티커 테이블과 재무제표 테이블 중 마법공식을 계산하는데 필요한 항목을 가져온다.</p></li>
<li><p>재무제표 항목별 TTM값을 구하며, 재무상태표 항목(부채, 유동부채, 유동자산, 비유동자산)은 평균값을 구한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pivot()</span></code> 함수를 통해 데이터를 피벗한다.</p></li>
<li><p>티커 테이블과 재무제표 테이블을 합친다.</p></li>
<li><p>티커 테이블에 있던 시가총액의 경우 원 단위인 반면, 재무제표 테이블의 숫자는 억 단위이므로 단위를 맞춰준다.</p></li>
</ol>
<p>먼저 밸류 지표에 해당하는 이익수익률을 계산한다. 이익수익률은 이자 및 법인세 차감전이익(EBIT)을 기업가치(시가총액 + 순차입금)로 나눈 값이다. 이를 분해하면 다음과 같다.</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align} 이익\ 수익률 &amp;= \frac{이자\ 및\ 법인세\ 차감전이익}{기업\ 가치} \\ &amp;= \frac{이자\ 및\ 법인세\ 차감전이익}{시가총액 + 순차입금} 
\\ &amp;= \frac{당기순이익 + 법인세 + 이자비용}{시가총액 + 총부채 - 여유자금}
\\ &amp;= \frac{당기순이익 + 법인세 + 이자비용}{시가총액 + 총부채 - (현금 - max(0, 유동부채 - 유동자산 + 현금))} \end{align} \end{split}\]</div>
<p>위 수식에 맞게 각 종목 별 이익 수익률을 계산해보도록 한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 분자(EBIT)</span>
<span class="n">magic_ebit</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;당기순이익&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;법인세비용&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;이자비용&#39;</span><span class="p">]</span>

<span class="c1"># 분모</span>
<span class="n">magic_cap</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;시가총액&#39;</span><span class="p">]</span>
<span class="n">magic_debt</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;부채&#39;</span><span class="p">]</span>

<span class="c1">## 분모: 여유자금</span>
<span class="n">magic_excess_cash</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;유동부채&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;유동자산&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_bind</span><span class="p">[</span>
    <span class="s1">&#39;현금및현금성자산&#39;</span><span class="p">]</span>
<span class="n">magic_excess_cash</span><span class="p">[</span><span class="n">magic_excess_cash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">magic_excess_cash_final</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;현금및현금성자산&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">magic_excess_cash</span>

<span class="n">magic_ev</span> <span class="o">=</span> <span class="n">magic_cap</span> <span class="o">+</span> <span class="n">magic_debt</span> <span class="o">-</span> <span class="n">magic_excess_cash_final</span>

<span class="c1"># 이익수익률</span>
<span class="n">magic_ey</span> <span class="o">=</span> <span class="n">magic_ebit</span> <span class="o">/</span> <span class="n">magic_ev</span>
</pre></div>
</div>
</div>
</div>
<ol class="simple">
<li><p>분자 부분인 이자 및 법인세 차감전 이익은 당기순이익에 법인세비용과 이자비용을 더해 계산한다.</p></li>
<li><p>분모 부분은 시가총액, 총 부채, 여유자금 총 세 가지로 구성되어 있다. 시가총액과 총 부채는 재무제표 데이터를 그대로 사용하며, 여유자금의 경우 세 단계를 통해 계산한다.</p></li>
<li><p>분자와 분모 부분을 나누어주면 이익수익률을 계산할 수 있다.</p></li>
</ol>
<p>다음으로 퀄리티 지표에 해당하는 투하자본 수익률을 계산한다. 해당 값은 이자 및 법인세 차감전이익(EBIT)를 투하자본(IC)으로 나누어 계산되며, 이를 분해하면 다음과 같다.</p>
<div class="math notranslate nohighlight">
\[\begin{split} \begin{align}
투하자본\ 수익률 &amp; = \frac{이자\ 및\ 법인세\ 차감전이익}{투하자본} \\
&amp; = \frac{당기순이익 + 법인세 + 이자비용}{(유동자산 - 유동부채) + (비유동자산 - 감가상각비)}
\end{align} \end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 투하자본 수익률</span>
<span class="n">magic_ic</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;유동자산&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;유동부채&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;비유동자산&#39;</span><span class="p">]</span> <span class="o">-</span>
                                                      <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;감가상각비&#39;</span><span class="p">])</span>
<span class="n">magic_roc</span> <span class="o">=</span> <span class="n">magic_ebit</span> <span class="o">/</span> <span class="n">magic_ic</span>
</pre></div>
</div>
</div>
</div>
<p>투하자본 수익률은 비교적 쉽게 계산할 수 있습니다. 분모에 해당하는 투하자본은 재무제표 항목을 그대로 사용하면 되며, 분자인 이자 및 법인세 차감전이익은 위에서 이미 구해둔 값을 사용하면 된다.</p>
<p>이제 두 지표를 활용해 마법공식 포트폴리오를 구성하겠다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 열 입력하기</span>
<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;이익 수익률&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magic_ey</span>
<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;투하자본 수익률&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magic_roc</span>

<span class="n">magic_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">magic_ey</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
              <span class="n">magic_roc</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">magic_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">,</span> <span class="s1">&#39;이익 수익률&#39;</span><span class="p">,</span> <span class="s1">&#39;투하자본 수익률&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>이익 수익률</th>
      <th>투하자본 수익률</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>184</th>
      <td>004000</td>
      <td>롯데정밀화학</td>
      <td>0.4689</td>
      <td>0.3579</td>
    </tr>
    <tr>
      <th>317</th>
      <td>007700</td>
      <td>F&amp;F홀딩스</td>
      <td>1.7336</td>
      <td>1.2130</td>
    </tr>
    <tr>
      <th>407</th>
      <td>011200</td>
      <td>HMM</td>
      <td>0.6160</td>
      <td>0.6362</td>
    </tr>
    <tr>
      <th>422</th>
      <td>011780</td>
      <td>금호석유</td>
      <td>0.4300</td>
      <td>0.4678</td>
    </tr>
    <tr>
      <th>816</th>
      <td>039560</td>
      <td>다산네트웍스</td>
      <td>0.5171</td>
      <td>0.3019</td>
    </tr>
    <tr>
      <th>1033</th>
      <td>058430</td>
      <td>포스코스틸리온</td>
      <td>0.4222</td>
      <td>0.4522</td>
    </tr>
    <tr>
      <th>1283</th>
      <td>084650</td>
      <td>랩지노믹스</td>
      <td>0.6426</td>
      <td>0.8998</td>
    </tr>
    <tr>
      <th>1392</th>
      <td>094970</td>
      <td>제이엠티</td>
      <td>0.4284</td>
      <td>0.3008</td>
    </tr>
    <tr>
      <th>1406</th>
      <td>096530</td>
      <td>씨젠</td>
      <td>0.3775</td>
      <td>0.6506</td>
    </tr>
    <tr>
      <th>1432</th>
      <td>100030</td>
      <td>모바일리더</td>
      <td>0.3441</td>
      <td>0.5361</td>
    </tr>
    <tr>
      <th>1472</th>
      <td>104480</td>
      <td>티케이케미칼</td>
      <td>0.5499</td>
      <td>0.6698</td>
    </tr>
    <tr>
      <th>1489</th>
      <td>108320</td>
      <td>LX세미콘</td>
      <td>0.3342</td>
      <td>0.5993</td>
    </tr>
    <tr>
      <th>1571</th>
      <td>124560</td>
      <td>태웅로직스</td>
      <td>0.3572</td>
      <td>0.9140</td>
    </tr>
    <tr>
      <th>1616</th>
      <td>137310</td>
      <td>에스디바이오센서</td>
      <td>0.4084</td>
      <td>0.7114</td>
    </tr>
    <tr>
      <th>1793</th>
      <td>205470</td>
      <td>휴마시스</td>
      <td>0.5648</td>
      <td>2.0810</td>
    </tr>
    <tr>
      <th>1874</th>
      <td>225220</td>
      <td>제놀루션</td>
      <td>0.4899</td>
      <td>0.5274</td>
    </tr>
    <tr>
      <th>1958</th>
      <td>253840</td>
      <td>수젠텍</td>
      <td>0.4060</td>
      <td>0.7822</td>
    </tr>
    <tr>
      <th>2056</th>
      <td>290270</td>
      <td>휴네시온</td>
      <td>0.4537</td>
      <td>0.4851</td>
    </tr>
    <tr>
      <th>2082</th>
      <td>298020</td>
      <td>효성티앤씨</td>
      <td>0.3415</td>
      <td>0.7508</td>
    </tr>
    <tr>
      <th>2206</th>
      <td>352770</td>
      <td>클리노믹스</td>
      <td>0.2891</td>
      <td>0.4868</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>‘이익 수익률’과 ‘투하자본 수익률’ 열에 위에서 계산한 값을 입력한다.</p></li>
<li><p>두 열의 순위를 각각 구한 후, 이 두 값을 합친다. 그 후 다시 합 기준으로 순위를 구한다.</p></li>
<li><p>최종 순위가 20위 이내인 종목을 선택한다.</p></li>
</ol>
<p>전체 종목과 선택된 종목들의 차이를 시각화 해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;투자구분&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">magic_rank</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;마법공식&#39;</span><span class="p">,</span> <span class="s1">&#39;기타&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;이익 수익률&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;투하자본 수익률&#39;</span><span class="p">,</span> <span class="n">hue</span> <span class="o">=</span> <span class="s1">&#39;투자구분&#39;</span><span class="p">,</span> <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;투자구분&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_90_0.png" src="_images/factor_90_0.png" />
</div>
</div>
<p>전체 종목 중 마법공식에 해당하는 종목들이 우측 상단, 즉 이익 수익률이 높고 투하자본 수익률도 높은 지점에 위치하고 있다.</p>
</div>
</div>
<div class="section" id="id18">
<h2><span class="section-number">13.7. </span>섹터 중립 포트폴리오<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p>팩터 전략의 단점 중 하나는 선택된 종목들이 특정 섹터로 쏠리는 경우가 있다는 점이다. 특히 과거 수익률을 토대로 종목을 선정하는 모멘텀 전략은 특정 섹터의 호황기에 동일한 섹터의 모든 종목이 함께 움직이는 경향이 있어 이러한 쏠림이 심할 수 있다.</p>
<p>먼저 12개월 모멘텀을 이용한 포트폴리오 구성 방법을 다시 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_ticker</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="s2">	and 종목구분 = &#39;보통주&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">sector_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_sector</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) ;	</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">price_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select 날짜, 종가, 종목코드</span>
<span class="s2">from kor_price</span>
<span class="s2">where 날짜 &gt;= (select (select max(날짜) from kor_price) - interval 1 year);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<span class="n">price_pivot</span> <span class="o">=</span> <span class="n">price_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;날짜&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;종가&#39;</span><span class="p">)</span>
<span class="n">ret_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>DB에서 티커 테이블과 섹터 테이블, 가격 테이블을 불러온 후, 12개월 수익률을 구한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;종목명&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sector_list</span><span class="p">[[</span><span class="s1">&#39;CMP_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]],</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                       <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
                                       <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;CMP_CD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ret_list</span><span class="p">,</span>
                                                                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                                <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>CMP_CD</th>
      <th>SEC_NM_KOR</th>
      <th>return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>000020</td>
      <td>건강관리</td>
      <td>-0.253472</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>000040</td>
      <td>경기관련소비재</td>
      <td>-0.420968</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>000050</td>
      <td>경기관련소비재</td>
      <td>-0.022556</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>000060</td>
      <td>금융</td>
      <td>0.460526</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>000070</td>
      <td>필수소비재</td>
      <td>-0.360173</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>티커 테이블과 섹터 테이블, 수익률 테이블을 하나로 합쳐준다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sector_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span>
                                          <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">sector_count</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sector_count</span><span class="p">[</span><span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_96_0.png" src="_images/factor_96_0.png" />
</div>
</div>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank()</span></code> 함수를 통해 12개월 수익률 열의 순위를 구하며, 모멘텀의 경우 지표가 높을수록 좋으므로 <code class="docutils literal notranslate"><span class="pre">ascending</span> <span class="pre">=</span> <span class="pre">False</span></code> 인자를 통해 내림차순으로 순위를 구한다.</p></li>
<li><p>모멘텀이 높은 20 종목들의 섹터를 선택한 후, <code class="docutils literal notranslate"><span class="pre">value_counts()</span></code> 메서드를 통해 섹터별 갯수를 구한다.</p></li>
<li><p>폰트를 지정한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">barh()</span></code> 함수를 통해 수평 막대 그래프를 그린다.</p></li>
<li><p>숫자가 큰 막대가 위로 가게하기 위해 <code class="docutils literal notranslate"><span class="pre">gca().invert_yaxis()</span></code>를 이용해 순서를 뒤집어준다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">annotate()</span></code> 함수를 이용해 각 막대의 끝에 갯수에 해당하는 글자를 추가한다.</p></li>
</ol>
<p>간혹 특정 섹터의 모멘텀이 매우 좋을 경우, 해당 섹터에 쏠림이 심한 경우가 있다. 이러한 섹터 쏠림 현상을 제거한 섹터 중립 포트폴리오를 구성해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;기타&#39;</span>
<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;z-score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">zscore</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
<span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;z-rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;z-score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sector_neutral_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;z-rank&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span>
                                                  <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Malgun Gothic&#39;</span><span class="p">)</span>
<span class="n">sector_neutral_count</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sector_neutral_count</span><span class="p">[</span><span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_98_0.png" src="_images/factor_98_0.png" />
</div>
</div>
<ol class="simple">
<li><p>섹터 정보가 비어있는 종목에는 섹터를 ‘기타’로 입력한다.</p></li>
<li><p>먼저 <code class="docutils literal notranslate"><span class="pre">groupby()</span></code> 함수를 통해 섹터별 그룹을 묶는다. 그 후 <code class="docutils literal notranslate"><span class="pre">apply()</span></code> 함수를 통해 수익률 열에 대해 그룹별로 Z-Score를 구해 정규화를 해준다. Z-Score는 <span class="math notranslate nohighlight">\(\frac{x-\mu}{\sigma}\)</span>로 계산된다.</p></li>
<li><p>정규화된 모멘텀이 높은 20 종목들의 섹터를 선택한 후, <code class="docutils literal notranslate"><span class="pre">value_counts()</span></code> 메서드를 통해 섹터별 갯수를 구한다.</p></li>
<li><p>폰트를 지정한다.</p></li>
<li><p>그림으로 나타낸다.</p></li>
</ol>
<p>해당 포트폴리오의 섹터별 구성종목을 확인해보면, 단순하게 포트폴리오를 구성한 것에 대비하여 여러 섹터에 종목이 분산되어 있다. 이처럼 <code class="docutils literal notranslate"><span class="pre">groupby()</span></code> 함수를 통해 손쉽게 그룹별 중립화를 할 수 있으며, 글로벌 투자를 하는 경우에는 지역, 국가, 섹터별로도 중립화된 포트폴리오를 구성하기도 한다.</p>
</div>
<div class="section" id="id19">
<h2><span class="section-number">13.8. </span>이상치 데이터 처리 및 팩터의 결합<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<p>훨씬 안정적인 퀀트 포트폴리오를 구성하기 위해서는 팩터 데이터를 어떻게 처리하여 결합할지에 대해서도 알고 있어야 하므로, 이러한 점에 대해 살펴보도록 하자.</p>
<p>모든 데이터 분석에서 중요한 문제 중 하나가 이상치(극단치, Outlier) 데이터를 어떻게 처리할 것인가이다. 과거 12개월 수익률이 10배인 주식이 과연 모멘텀 관점에서 좋기만 한 주식인지, ROE가 100%를 넘는 주식이 과연 퀄리티 관점에서 좋기만 한 주식인지 고민이 되기 마련이다. 따라서 이러한 이상치를 제외하고 분석할지, 포함해서 분석할지를 판단해야 한다. 만일 이상치를 포함한다면 그대로 사용할 것인지, 보정해 사용할 것인지도 판단해야 한다.</p>
<p>우리가 가지고 있는 PBR 데이터에서 이상치 데이터를 탐색해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">value_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_value</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_value);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<span class="n">value_pbr</span> <span class="o">=</span> <span class="n">value_list</span><span class="p">[</span><span class="n">value_list</span><span class="p">[</span><span class="s1">&#39;지표&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PBR&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>74.4432 
 -8.796
</pre></div>
</div>
</div>
</div>
<p>먼저 밸류 테이블을 불러온 후 PBR 데이터만 선택한다. PBR의 최대값과 최소값을 확인해보면 값이 매우 큰 것을 확인할 수 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_102_0.png" src="_images/factor_102_0.png" />
</div>
</div>
<p>국내 종목들의 PBR을 히스토그램으로 그려보면 오른쪽으로 꼬리가 매우 긴 분포를 보인다. 이는 PBR이 극단적으로 큰 이상치 데이터가 있기 때문이다. 이처럼 모든 팩터 데이터에는 극단치가 있기 마련이며, 이를 처리하는 방법을 알아보도록 하자.</p>
<div class="section" id="trim">
<h3><span class="section-number">13.8.1. </span>트림(Trim): 이상치 데이터 삭제<a class="headerlink" href="#trim" title="Permalink to this headline">¶</a></h3>
<p>트림은 이상치 데이터를 삭제하는 방법이다. 위의 예제에서 이상치에 해당하는 상하위 1% 데이터를 삭제하겠다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q_low</span> <span class="o">=</span> <span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">q_hi</span> <span class="o">=</span> <span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.99</span><span class="p">)</span>

<span class="n">value_trim</span> <span class="o">=</span> <span class="n">value_pbr</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">q_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">value_pbr</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">q_hi</span><span class="p">),</span>
                           <span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]]</span>

<span class="n">value_trim</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_104_0.png" src="_images/factor_104_0.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">quantile()</span></code> 함수를 통해 백분위를 구한 후 상하위 1%에 해당하는 데이터를 제외한 데이터만 선택했다. 결과적으로 지나치게 PBR이 낮은 종목과 높은 종목은 제거되어 <span class="math notranslate nohighlight">\(x\)</span>축의 스케일이 많이 줄어든 모습이다.</p>
<p>평균이나 분산 같이 통계값을 구하는 과정에서는 이상치 데이터를 제거하는 것이 바람직할 수 있다. 그러나 팩터를 이용해 포트폴리오를 구하는 과정에서 해당 방법은 조심스럽게 사용되어야 한다. 데이터의 손실이 발생하게 되며, 제거된 종목 중 정말로 좋은 종목이 있을 수도 있기 때문이다.</p>
</div>
<div class="section" id="winsorizing">
<h3><span class="section-number">13.8.2. </span>윈저라이징(Winsorizing): 이상치 데이터 대체<a class="headerlink" href="#winsorizing" title="Permalink to this headline">¶</a></h3>
<p>이상치 데이터를 다른 데이터로 대체하는 윈저라이징 방법을 사용할 수도 있다. 예를 들어 상위 1%를 초과하는 데이터는 1% 값으로 대체하며, 하위 1% 미만의 데이터는 1% 데이터로 대체한다. 즉, 좌우로 울타리를 쳐놓고 해당 범위를 넘어가는 값을 강제로 울타리에 맞춰준다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_winsor</span> <span class="o">=</span> <span class="n">value_pbr</span><span class="p">[[</span><span class="s1">&#39;값&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">value_winsor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_winsor</span><span class="p">[</span><span class="s2">&quot;값&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">q_low</span><span class="p">,</span> <span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_low</span>
<span class="n">value_winsor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_winsor</span><span class="p">[</span><span class="s2">&quot;값&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">q_hi</span><span class="p">,</span> <span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_hi</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">value_winsor</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_fc</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">patches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_fc</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_106_0.png" src="_images/factor_106_0.png" />
</div>
</div>
<p>이번에는 값이 상하위 1%를 벗어나는 경우, 1%에 해당하는 값으로 대체하였다. 그림을 살펴보면 <span class="math notranslate nohighlight">\(x\)</span>축 양 끝부분의 막대(붉은색)가 길어진 것을 확인할 수 있다.</p>
</div>
<div class="section" id="id20">
<h3><span class="section-number">13.8.3. </span>팩터의 결합 방법<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>앞서 밸류 지표의 결합, 퀄리티 지표의 결합, 마법공식 포트폴리오를 구성할 때는 단순히 순위를 더하는 방법을 사용했다. 물론 투자 종목수가 얼마 되지 않거나, 개인 투자자의 입장에서는 이러한 방법이 가장 단순하면서도 효과적일수 있다. 그러나 전문투자자가 포트폴리오를 구성하거나 팩터를 분석하는 업무를 할 경우 이처럼 단순히 순위를 더하는 방법은 여러 가지 문제를 안고 있다.</p>
<p>각 밸류 지표의 순위를 구한 후 히스토그램으로 나타내보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_pivot</span> <span class="o">=</span> <span class="n">value_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;지표&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;값&#39;</span><span class="p">)</span>
<span class="n">value_rank</span> <span class="o">=</span> <span class="n">value_pivot</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">value_rank</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">value_rank</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_108_0.png" src="_images/factor_108_0.png" />
</div>
</div>
<p>그림에서 알 수 있듯이 순위를 구하는 것의 가장 큰 장점은 극단치로 인한 효과가 사라진다는 점과 균등한 분포를 가진다는 점이다. 그러나 각 지표의 <span class="math notranslate nohighlight">\(x\)</span>축을 보면 최댓값이 서로 다르다. 이는 지표별 결측치로 인해 유효 데이터의 갯수가 달라 나타나는 현상이다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_pivot</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>지표
DY     1119
PBR       0
PCR       9
PER       9
PSR      82
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>각 열의 na 개수를 확인해보면 그 결과가 모두 다르며, 특히 배당 수익률의 경우 절반 정도가 na 데이터다. 따라서 서로 다른 범위의 분포를 단순히 합치는 것은 좋은 방법이 아니다. 예를 들어 A, B, C, D 팩터에 각각 비중을 25%, 25%, 25%, 25% 부여해 포트폴리오를 구성한다고 가정해보자. 각 순위는 분포의 범위가 다르므로, 순위와 비중의 가중평균을 통해 포트폴리오를 구성하면 왜곡된 결과를 발생시킨다.</p>
<p>이러한 문제를 해결하는 가장 좋은 방법은 순위를 구한 후 이를 Z-Score로 정규화하는 것이다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>

<span class="n">value_rank_z</span> <span class="o">=</span> <span class="n">value_rank</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">zscore</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">value_rank_z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">value_rank</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_112_0.png" src="_images/factor_112_0.png" />
</div>
</div>
<p>앞서 구해진 순위에 <code class="docutils literal notranslate"><span class="pre">apply(zscore)</span></code> 함수를 통해 정규화를 해준다. 기본적으로 순위의 분포가 가진 극단치 효과가 사라지는 점과 균등 분포의 장점을 유지하고 있으며, 분포의 범위 역시 거의 동일하게 바뀌었다. 이처럼 여러 팩터를 결합해 포트폴리오를 구성하고자 하는 경우, 먼저 각 팩터(지표)별 순위를 구한 후 이를 정규화한 뒤 더해야 왜곡 효과가 제거되어 안정적인 포트폴리오가 된다.</p>
<div class="math notranslate nohighlight">
\[Z - Score(Rank(Factor\ A)) + Z - Score(Rank(Factor\ B)) +\dots + Z - Score(Rank(Factor\ N))\]</div>
</div>
</div>
<div class="section" id="id21">
<h2><span class="section-number">13.9. </span>멀티팩터 포트폴리오<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<p>앞에서 배웠던 팩터 이론들과 결합 방법들을 응용해 멀티팩터 포트폴리오를 구성해보자. 각 팩터에 사용되는 지표는 다음과 같다.</p>
<ul class="simple">
<li><p>퀄리티: 자기자본이익률(ROE), 매출총이익(GPA), 영업활동현금흐름(OCFA)</p></li>
<li><p>밸류: PER, PBR, PSR, PCR</p></li>
<li><p>모멘텀: 12개월 수익률, K-Ratio</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;mysql+pymysql://root:1234@127.0.0.1:3306/stock_db&#39;</span><span class="p">)</span>

<span class="n">ticker_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_ticker</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker) </span>
<span class="s2">	and 종목구분 = &#39;보통주&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">fs_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_fs</span>
<span class="s2">where 계정 in (&#39;당기순이익&#39;, &#39;매출총이익&#39;, &#39;영업활동으로인한현금흐름&#39;, &#39;자산&#39;, &#39;자본&#39;)</span>
<span class="s2">and 공시구분 = &#39;q&#39;;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">value_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_value</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_value);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">price_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select 날짜, 종가, 종목코드</span>
<span class="s2">from kor_price</span>
<span class="s2">where 날짜 &gt;= (select (select max(날짜) from kor_price) - interval 1 year);</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">sector_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select * from kor_sector</span>
<span class="s2">where 기준일 = (select max(기준일) from kor_ticker);	</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>먼저 티커, 재무제표, 가치지표, 주가, 섹터 테이블을 불러온다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fs_list</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="s1">&#39;기준일&#39;</span><span class="p">])</span>
<span class="n">fs_list</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>
    <span class="n">window</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span>
<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;계정&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;자산&#39;</span><span class="p">,</span> <span class="s1">&#39;지배기업주주지분&#39;</span><span class="p">]),</span>
                                <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fs_list_clean</span><span class="p">[</span><span class="s1">&#39;ttm&#39;</span><span class="p">])</span>
<span class="n">fs_list_clean</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;계정&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fs_list_pivot</span> <span class="o">=</span> <span class="n">fs_list_clean</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;계정&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;ttm&#39;</span><span class="p">)</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;ROE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;당기순이익&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자본&#39;</span><span class="p">]</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;GPA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;매출총이익&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자산&#39;</span><span class="p">]</span>
<span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;CFO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;영업활동으로인한현금흐름&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fs_list_pivot</span><span class="p">[</span><span class="s1">&#39;자산&#39;</span><span class="p">]</span>

<span class="n">fs_list_pivot</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>계정</th>
      <th>당기순이익</th>
      <th>매출총이익</th>
      <th>영업활동으로인한현금흐름</th>
      <th>자본</th>
      <th>자산</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
    </tr>
    <tr>
      <th>종목코드</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000020</th>
      <td>198.0</td>
      <td>1582.0</td>
      <td>438.0</td>
      <td>14245.0</td>
      <td>4507.00</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
    </tr>
    <tr>
      <th>000040</th>
      <td>-130.0</td>
      <td>181.0</td>
      <td>-86.0</td>
      <td>2013.0</td>
      <td>1727.50</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
    </tr>
    <tr>
      <th>000050</th>
      <td>306.0</td>
      <td>1440.0</td>
      <td>359.0</td>
      <td>30203.0</td>
      <td>12790.00</td>
      <td>0.0101</td>
      <td>0.1126</td>
      <td>0.0281</td>
    </tr>
    <tr>
      <th>000060</th>
      <td>7441.0</td>
      <td>NaN</td>
      <td>11081.0</td>
      <td>88710.0</td>
      <td>271524.00</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
    </tr>
    <tr>
      <th>000070</th>
      <td>2384.0</td>
      <td>7047.0</td>
      <td>2021.0</td>
      <td>96729.0</td>
      <td>44074.75</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>퀄리티 지표를 계산하기 위해 TTM 기준 ROE, GPA, CFO를 계산한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value_list</span><span class="p">[</span><span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;값&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">value_pivot</span> <span class="o">=</span> <span class="n">value_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;지표&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;값&#39;</span><span class="p">)</span>

<span class="n">value_pivot</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>지표</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
    </tr>
    <tr>
      <th>종목코드</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000020</th>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
    </tr>
    <tr>
      <th>000040</th>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
    </tr>
    <tr>
      <th>000050</th>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
    </tr>
    <tr>
      <th>000060</th>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>000070</th>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>가치 지표의 경우 음수를 제거한 후 행으로 긴 형태로 변경한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_pivot</span> <span class="o">=</span> <span class="n">price_list</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;날짜&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;종가&#39;</span><span class="p">)</span>
<span class="n">ret_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;12M&#39;</span><span class="p">])</span>

<span class="n">ret</span> <span class="o">=</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">ret_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)))</span>
<span class="n">k_ratio</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ticker_list</span><span class="p">)):</span>

    <span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;종목코드&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">ret_cum</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">price_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">]</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">params</span> <span class="o">/</span> <span class="n">reg</span><span class="o">.</span><span class="n">bse</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">k_ratio</span><span class="p">[</span><span class="n">ticker</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

<span class="n">k_ratio_bind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">k_ratio</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">k_ratio_bind</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;K_ratio&#39;</span><span class="p">]</span>

<span class="n">k_ratio_bind</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>K_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>-16.906563</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>-68.767035</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>10.528547</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>34.998428</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>-79.903455</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>먼저 가격 테이블을 이용해 최근 12개월 수익률을 구한다. 또한 로그 누적수익률을 통해 각 종목 별 K-Ratio를 계산한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind</span> <span class="o">=</span> <span class="n">ticker_list</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;종목명&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">sector_list</span><span class="p">[[</span><span class="s1">&#39;CMP_CD&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]],</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
    <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;CMP_CD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">fs_list_pivot</span><span class="p">[[</span><span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span> <span class="s1">&#39;CFO&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">value_pivot</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                         <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ret_list</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                          <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">k_ratio_bind</span><span class="p">,</span>
                                                           <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                                           <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data_bind</span><span class="p">[</span><span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;기타&#39;</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;CMP_CD&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>SEC_NM_KOR</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>건강관리</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
      <td>-0.2535</td>
      <td>-16.9066</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>경기관련소비재</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
      <td>-0.4210</td>
      <td>-68.7670</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>경기관련소비재</td>
      <td>0.0101</td>
      <td>0.1126</td>
      <td>0.0281</td>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
      <td>-0.0226</td>
      <td>10.5285</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>금융</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
      <td>0.4605</td>
      <td>34.9984</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>필수소비재</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
      <td>-0.3602</td>
      <td>-79.9035</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>티커, 섹터, 퀄리티, 밸류, 12개월 수익률, K-ratio 테이블을 하나로 합친다.</p></li>
<li><p>섹터 정보가 없는 경우 ‘기타’를 입력한다.</p></li>
<li><p>CMP_CD(종목코드)는 중복되는 열이므로 <code class="docutils literal notranslate"><span class="pre">drop()</span></code> 메서드를 통해 제거한다.</p></li>
</ol>
<p>이번에는 각 섹터별로 아웃라이어를 제거한 후 순위와 Z-Score를 구하는 함수(col_clean)를 만들어보도록 하겠다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">col_clean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">asc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">q_low</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
    <span class="n">q_hi</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cutoff</span><span class="p">)</span>

    <span class="n">df_trim</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="n">q_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span> <span class="o">&lt;</span> <span class="n">q_hi</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">asc</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">df_z_score</span> <span class="o">=</span> <span class="n">df_trim</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">zscore</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">asc</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">df_z_score</span> <span class="o">=</span> <span class="n">df_trim</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">zscore</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df_z_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ol class="simple">
<li><p>cutoff 즉 아웃라이어는 1%로 설정하며, asc는 False로 설정한다.</p></li>
<li><p>아웃라이어 기준에 해당하는 q_low와 q_hi을 계산한다.</p></li>
<li><p>트림 방법을 통해 이상치 데이터를 제외한 값을 선택한다.</p></li>
<li><p>만일 asc가 False일 경우 순위를 ascending = False 즉 내림차순으로 계산한다. 만일 asc가 True일 경우에는 순위를 ascending = True 즉 오름차순으로 계산한다. 그 후 <code class="docutils literal notranslate"><span class="pre">apply()</span></code> 메서드를 통해 zscore를 계산한다.</p></li>
</ol>
<p>이제 해당 함수를 각 팩터에 적용해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind_group</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">)</span>

<span class="n">data_bind_group</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>종목명</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
    </tr>
    <tr>
      <th>종목코드</th>
      <th>SEC_NM_KOR</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000020</th>
      <th>건강관리</th>
      <td>동화약품</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
      <td>-0.2535</td>
      <td>-16.9066</td>
    </tr>
    <tr>
      <th>000040</th>
      <th>경기관련소비재</th>
      <td>KR모터스</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
      <td>-0.4210</td>
      <td>-68.7670</td>
    </tr>
    <tr>
      <th>000060</th>
      <th>금융</th>
      <td>메리츠화재</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
      <td>0.4605</td>
      <td>34.9984</td>
    </tr>
    <tr>
      <th>000070</th>
      <th>필수소비재</th>
      <td>삼양홀딩스</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
      <td>-0.3602</td>
      <td>-79.9035</td>
    </tr>
    <tr>
      <th>000120</th>
      <th>산업재</th>
      <td>CJ대한통운</td>
      <td>0.0108</td>
      <td>0.1214</td>
      <td>0.0261</td>
      <td>NaN</td>
      <td>0.6688</td>
      <td>11.2231</td>
      <td>15.5327</td>
      <td>0.2309</td>
      <td>-0.3499</td>
      <td>-60.8105</td>
    </tr>
    <tr>
      <th>000180</th>
      <th>소재</th>
      <td>성창기업지주</td>
      <td>-0.0005</td>
      <td>0.0438</td>
      <td>0.0133</td>
      <td>NaN</td>
      <td>0.2614</td>
      <td>14.9416</td>
      <td>NaN</td>
      <td>0.6897</td>
      <td>-0.2926</td>
      <td>-32.4441</td>
    </tr>
    <tr>
      <th>000440</th>
      <th>에너지</th>
      <td>중앙에너비스</td>
      <td>0.0021</td>
      <td>0.1665</td>
      <td>-0.0264</td>
      <td>0.0158</td>
      <td>2.1211</td>
      <td>NaN</td>
      <td>252.1980</td>
      <td>1.9734</td>
      <td>0.2433</td>
      <td>22.6172</td>
    </tr>
    <tr>
      <th>000660</th>
      <th>IT</th>
      <td>SK하이닉스</td>
      <td>0.0443</td>
      <td>0.2425</td>
      <td>0.2436</td>
      <td>0.0154</td>
      <td>1.2175</td>
      <td>3.3499</td>
      <td>6.8637</td>
      <td>1.5603</td>
      <td>-0.1410</td>
      <td>-8.4635</td>
    </tr>
    <tr>
      <th>003480</th>
      <th>유틸리티</th>
      <td>한진중공업홀딩스</td>
      <td>-0.0088</td>
      <td>0.0645</td>
      <td>0.0640</td>
      <td>0.0249</td>
      <td>0.3351</td>
      <td>1.0373</td>
      <td>NaN</td>
      <td>0.1106</td>
      <td>-0.3092</td>
      <td>-26.6649</td>
    </tr>
    <tr>
      <th>003560</th>
      <th>커뮤니케이션서비스</th>
      <td>IHQ</td>
      <td>-0.0127</td>
      <td>0.2403</td>
      <td>0.0383</td>
      <td>NaN</td>
      <td>0.9567</td>
      <td>12.9532</td>
      <td>NaN</td>
      <td>2.0622</td>
      <td>-0.6026</td>
      <td>-71.1492</td>
    </tr>
    <tr>
      <th>003620</th>
      <th>기타</th>
      <td>쌍용차</td>
      <td>0.8676</td>
      <td>0.0586</td>
      <td>0.0522</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.2138</td>
      <td>NaN</td>
      <td>0.1592</td>
      <td>0.0000</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>먼저 종목코드와 섹터정보(SEC_NM_KOR)를 인덱스로 설정한 후, 섹터에 따른 그룹을 묶어준다. 첫번째로 퀄리티 지표의 Z-Score를 계산해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_quality</span> <span class="o">=</span> <span class="n">data_bind_group</span><span class="p">[[</span><span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span> <span class="s1">&#39;CFO&#39;</span>
                             <span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">col_clean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;z_quality&#39;</span><span class="p">)</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">z_quality</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">])</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>SEC_NM_KOR</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
      <th>z_quality</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>건강관리</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
      <td>-0.2535</td>
      <td>-16.9066</td>
      <td>-2.4452</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>경기관련소비재</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
      <td>-0.4210</td>
      <td>-68.7670</td>
      <td>3.5055</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>경기관련소비재</td>
      <td>0.0101</td>
      <td>0.1126</td>
      <td>0.0281</td>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
      <td>-0.0226</td>
      <td>10.5285</td>
      <td>0.4033</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>금융</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
      <td>0.4605</td>
      <td>34.9984</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>필수소비재</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
      <td>-0.3602</td>
      <td>-79.9035</td>
      <td>-0.7954</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>섹터별 그룹으로 묶인 테이블에서 퀄리티 지표에 해당하는 ROE, GPA, CFO 열을 선택한 후, 위에서 만든 <code class="docutils literal notranslate"><span class="pre">col_clean()</span></code> 함수를 적용하면 아웃라이어를 제거한 후 랭킹의 Z-Score를 계산한다</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sum()</span></code> 함수를 통해 Z-Score의 합을 구하며, <code class="docutils literal notranslate"><span class="pre">to_frame()</span></code> 메서드를 통해 데이터프레임 형태로 변경한다.</p></li>
<li><p>data_bind 테이블과 합치며, z_quality 열에는 퀄리티 지표의 Z-Score가 표시된다.</p></li>
</ol>
<p>두번째로 밸류 지표의 Z-Score를 계산해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">value_1</span> <span class="o">=</span> <span class="n">data_bind_group</span><span class="p">[[</span><span class="s1">&#39;PBR&#39;</span><span class="p">,</span> <span class="s1">&#39;PCR&#39;</span><span class="p">,</span> <span class="s1">&#39;PER&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;PSR&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">col_clean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="n">value_2</span> <span class="o">=</span> <span class="n">data_bind_group</span><span class="p">[[</span><span class="s1">&#39;DY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">col_clean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

<span class="n">z_value</span> <span class="o">=</span> <span class="n">value_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">value_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span>
                                     <span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;z_value&#39;</span><span class="p">)</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">z_value</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">])</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>SEC_NM_KOR</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
      <th>z_quality</th>
      <th>z_value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>건강관리</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
      <td>-0.2535</td>
      <td>-16.9066</td>
      <td>-2.4452</td>
      <td>-4.8620</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>경기관련소비재</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
      <td>-0.4210</td>
      <td>-68.7670</td>
      <td>3.5055</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>경기관련소비재</td>
      <td>0.0101</td>
      <td>0.1126</td>
      <td>0.0281</td>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
      <td>-0.0226</td>
      <td>10.5285</td>
      <td>0.4033</td>
      <td>0.8432</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>금융</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
      <td>0.4605</td>
      <td>34.9984</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>필수소비재</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
      <td>-0.3602</td>
      <td>-79.9035</td>
      <td>-0.7954</td>
      <td>-6.8874</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>밸류 지표에 해당하는 PBR, PCR, PER, PSR 열을 선택한 후, <code class="docutils literal notranslate"><span class="pre">col_clean()</span></code> 함수를 적용한다. 또한 인자에 True를 입력해 오름차순으로 순위를 구한다.</p></li>
<li><p>DY(배당수익률)의 경우 내림차순으로 순위를 계산해야 하므로 <code class="docutils literal notranslate"><span class="pre">col_clean()</span></code> 함수에 False를 입력한다.</p></li>
<li><p>위의 두 결과를 합친 후 데이터프레임 형태로 변경한다.</p></li>
<li><p>data_bind 테이블과 합치며, z_value 열에는 밸류 지표의 Z-Score가 표시된다.</p></li>
</ol>
<p>마지막으로 모멘텀 지표의 Z-Score를 계산해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_momentum</span> <span class="o">=</span> <span class="n">data_bind_group</span><span class="p">[[</span>
    <span class="s1">&#39;12M&#39;</span><span class="p">,</span> <span class="s1">&#39;K_ratio&#39;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">col_clean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;z_momentum&#39;</span><span class="p">)</span>
<span class="n">data_bind</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">z_momentum</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;SEC_NM_KOR&#39;</span><span class="p">])</span>

<span class="n">data_bind</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>SEC_NM_KOR</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
      <th>z_quality</th>
      <th>z_value</th>
      <th>z_momentum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>000020</td>
      <td>동화약품</td>
      <td>건강관리</td>
      <td>0.0139</td>
      <td>0.3510</td>
      <td>0.0972</td>
      <td>0.0167</td>
      <td>0.8471</td>
      <td>6.8872</td>
      <td>15.2354</td>
      <td>0.9842</td>
      <td>-0.2535</td>
      <td>-16.9066</td>
      <td>-2.4452</td>
      <td>-4.8620</td>
      <td>-1.4104</td>
    </tr>
    <tr>
      <th>1</th>
      <td>000040</td>
      <td>KR모터스</td>
      <td>경기관련소비재</td>
      <td>-0.0646</td>
      <td>0.1048</td>
      <td>-0.0498</td>
      <td>NaN</td>
      <td>1.4194</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.5102</td>
      <td>-0.4210</td>
      <td>-68.7670</td>
      <td>3.5055</td>
      <td>NaN</td>
      <td>2.5349</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000050</td>
      <td>경방</td>
      <td>경기관련소비재</td>
      <td>0.0101</td>
      <td>0.1126</td>
      <td>0.0281</td>
      <td>0.0098</td>
      <td>0.4647</td>
      <td>9.7748</td>
      <td>11.4678</td>
      <td>0.8826</td>
      <td>-0.0226</td>
      <td>10.5285</td>
      <td>0.4033</td>
      <td>0.8432</td>
      <td>-2.7717</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000060</td>
      <td>메리츠화재</td>
      <td>금융</td>
      <td>0.0839</td>
      <td>NaN</td>
      <td>0.0408</td>
      <td>0.0189</td>
      <td>1.7301</td>
      <td>3.4626</td>
      <td>5.1565</td>
      <td>NaN</td>
      <td>0.4605</td>
      <td>34.9984</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>000070</td>
      <td>삼양홀딩스</td>
      <td>필수소비재</td>
      <td>0.0246</td>
      <td>0.1599</td>
      <td>0.0459</td>
      <td>0.0416</td>
      <td>0.2557</td>
      <td>3.0596</td>
      <td>2.5937</td>
      <td>0.1915</td>
      <td>-0.3602</td>
      <td>-79.9035</td>
      <td>-0.7954</td>
      <td>-6.8874</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>모멘텀 지표에 해당하는 12M, K_ratio 열을 선택한 후 <code class="docutils literal notranslate"><span class="pre">col_clean()</span></code> 함수를 적용한다.</p></li>
<li><p>data_bind 테이블과 합치며, z_momentum 열에는 모멘텀 지표의 Z-Score가 표시된다.</p></li>
</ol>
<p>각 팩터의 분포를 시가화해보도록 하자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_z</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[[</span><span class="s1">&#39;z_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;z_value&#39;</span><span class="p">,</span> <span class="s1">&#39;z_momentum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">unicode_minus</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data_z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">data_z</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_134_0.png" src="_images/factor_134_0.png" />
</div>
</div>
<p>각각 퀄리티 지표는 3개, 밸류 지표는 4개, 모멘텀 지표는 2개 기준을 이용해 계산했다. 그림에서 알 수 있듯이 기준을 많이 사용할 수록 Z-Score가 넓게 퍼져있는 모습을 보이며, 각 팩터별 분포가 동일하지 않다. 따라서 다시 Z-Score를 계산해 분포의 넓이를 비슷하게 맞춰주도록 한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_bind_final</span> <span class="o">=</span> <span class="n">data_bind</span><span class="p">[[</span><span class="s1">&#39;종목코드&#39;</span><span class="p">,</span> <span class="s1">&#39;z_quality&#39;</span><span class="p">,</span> <span class="s1">&#39;z_value&#39;</span><span class="p">,</span> <span class="s1">&#39;z_momentum&#39;</span>
                             <span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">zscore</span><span class="p">,</span>
                                                        <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
<span class="n">data_bind_final</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;momenmum&#39;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">unicode_minus</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data_bind_final</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">n</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">data_bind_final</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_136_0.png" src="_images/factor_136_0.png" />
</div>
</div>
<ol class="simple">
<li><p>종목코드와 각 팩터의 Z-Score만 선택한 후, 종목코드를 인덱스로 설정한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apply()</span></code> 함수를 통해 팩터별로 다시 한번 Z-Score를 계산한다.</p></li>
<li><p>열 이름을 설정한다.</p></li>
</ol>
<p>재계산된 Z-Score의 분포의 넓이를 살펴보면 이전에 비해 훨씬 비슷해진 것을 알 수 있다. 각 팩터들 간의 상관관계를 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">data_bind_final</span><span class="o">.</span><span class="n">corr</span><span class="p">())</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">data_bind_final</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
            <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">},</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span>
            <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_138_0.png" src="_images/factor_138_0.png" />
</div>
</div>
<p>각 팩터간 상관관계가 매우 낮으며, 여러 팩터를 동시에 고려함으로서 분산효과를 기대할 수 있다. 이제 계산된 팩터들을 토대로 최종 포트폴리오를 구성해보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="n">data_bind_final_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_bind_final</span> <span class="o">*</span> <span class="n">wts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
<span class="n">data_bind_final_sum</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qvm&#39;</span><span class="p">]</span>
<span class="n">port_qvm</span> <span class="o">=</span> <span class="n">data_bind</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_bind_final_sum</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;종목코드&#39;</span><span class="p">)</span>
<span class="n">port_qvm</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">port_qvm</span><span class="p">[</span><span class="s1">&#39;qvm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span>

<span class="n">port_qvm</span><span class="p">[</span><span class="n">port_qvm</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>종목코드</th>
      <th>종목명</th>
      <th>SEC_NM_KOR</th>
      <th>ROE</th>
      <th>GPA</th>
      <th>CFO</th>
      <th>DY</th>
      <th>PBR</th>
      <th>PCR</th>
      <th>PER</th>
      <th>PSR</th>
      <th>12M</th>
      <th>K_ratio</th>
      <th>z_quality</th>
      <th>z_value</th>
      <th>z_momentum</th>
      <th>qvm</th>
      <th>invest</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>53</th>
      <td>001120</td>
      <td>LX인터내셔널</td>
      <td>산업재</td>
      <td>0.0731</td>
      <td>0.2199</td>
      <td>0.0259</td>
      <td>0.0742</td>
      <td>0.5275</td>
      <td>6.7239</td>
      <td>1.8052</td>
      <td>0.0671</td>
      <td>0.0113</td>
      <td>1.7051</td>
      <td>-3.1728</td>
      <td>-6.5511</td>
      <td>-2.4125</td>
      <td>-1.3268</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>158</th>
      <td>003380</td>
      <td>하림지주</td>
      <td>필수소비재</td>
      <td>0.0366</td>
      <td>0.1835</td>
      <td>0.0871</td>
      <td>0.0123</td>
      <td>0.2198</td>
      <td>0.9171</td>
      <td>1.5011</td>
      <td>0.0760</td>
      <td>-0.1266</td>
      <td>-0.6753</td>
      <td>-2.5275</td>
      <td>-6.2164</td>
      <td>-1.7846</td>
      <td>-1.1143</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>173</th>
      <td>003650</td>
      <td>미창석유</td>
      <td>에너지</td>
      <td>0.0289</td>
      <td>0.1596</td>
      <td>0.0883</td>
      <td>0.0309</td>
      <td>0.4726</td>
      <td>4.6087</td>
      <td>4.0862</td>
      <td>0.3363</td>
      <td>-0.0244</td>
      <td>-6.2214</td>
      <td>-3.0456</td>
      <td>-4.5772</td>
      <td>-2.3105</td>
      <td>-1.1155</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>348</th>
      <td>009160</td>
      <td>SIMPAC</td>
      <td>산업재</td>
      <td>0.0563</td>
      <td>0.2345</td>
      <td>0.1310</td>
      <td>0.0322</td>
      <td>0.7671</td>
      <td>3.4639</td>
      <td>3.4087</td>
      <td>0.5706</td>
      <td>-0.0850</td>
      <td>3.8914</td>
      <td>-4.4524</td>
      <td>-3.8121</td>
      <td>-2.3300</td>
      <td>-1.2265</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>375</th>
      <td>009970</td>
      <td>영원무역홀딩스</td>
      <td>경기관련소비재</td>
      <td>0.0413</td>
      <td>0.3200</td>
      <td>0.0763</td>
      <td>0.0417</td>
      <td>0.2144</td>
      <td>2.0295</td>
      <td>1.2968</td>
      <td>0.1877</td>
      <td>0.0203</td>
      <td>16.6428</td>
      <td>-3.3711</td>
      <td>-7.5615</td>
      <td>-3.0510</td>
      <td>-1.5460</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>418</th>
      <td>011560</td>
      <td>세보엠이씨</td>
      <td>산업재</td>
      <td>0.0257</td>
      <td>0.0929</td>
      <td>0.1443</td>
      <td>0.0312</td>
      <td>0.5311</td>
      <td>1.9893</td>
      <td>5.1746</td>
      <td>0.1551</td>
      <td>0.1080</td>
      <td>2.0713</td>
      <td>-2.0389</td>
      <td>-5.5735</td>
      <td>-2.6496</td>
      <td>-1.1334</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>626</th>
      <td>026040</td>
      <td>제이에스티나</td>
      <td>경기관련소비재</td>
      <td>0.0869</td>
      <td>0.6664</td>
      <td>0.0726</td>
      <td>0.0340</td>
      <td>0.9034</td>
      <td>9.5301</td>
      <td>2.5991</td>
      <td>0.6846</td>
      <td>0.0387</td>
      <td>12.3943</td>
      <td>-4.1363</td>
      <td>-2.2451</td>
      <td>-2.9990</td>
      <td>-1.1521</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>654</th>
      <td>030200</td>
      <td>KT</td>
      <td>커뮤니케이션서비스</td>
      <td>0.0245</td>
      <td>0.6964</td>
      <td>0.1450</td>
      <td>0.0516</td>
      <td>0.5952</td>
      <td>1.8456</td>
      <td>6.0827</td>
      <td>0.3842</td>
      <td>0.1131</td>
      <td>4.7558</td>
      <td>-3.0980</td>
      <td>-7.5017</td>
      <td>-2.5661</td>
      <td>-1.4283</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>920</th>
      <td>049070</td>
      <td>인탑스</td>
      <td>IT</td>
      <td>0.0453</td>
      <td>0.2402</td>
      <td>0.1069</td>
      <td>0.0161</td>
      <td>0.7871</td>
      <td>5.5462</td>
      <td>4.3410</td>
      <td>0.4226</td>
      <td>0.0733</td>
      <td>6.5720</td>
      <td>-2.9346</td>
      <td>-5.2537</td>
      <td>-2.5792</td>
      <td>-1.2060</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>991</th>
      <td>053690</td>
      <td>한미글로벌</td>
      <td>산업재</td>
      <td>0.0293</td>
      <td>0.3556</td>
      <td>0.1123</td>
      <td>0.0386</td>
      <td>0.9068</td>
      <td>4.2981</td>
      <td>7.7367</td>
      <td>0.4394</td>
      <td>0.0216</td>
      <td>7.5404</td>
      <td>-4.0259</td>
      <td>-3.2718</td>
      <td>-2.6806</td>
      <td>-1.1801</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1008</th>
      <td>054670</td>
      <td>대한뉴팜</td>
      <td>건강관리</td>
      <td>0.0740</td>
      <td>0.5644</td>
      <td>0.1065</td>
      <td>0.0076</td>
      <td>1.9152</td>
      <td>9.2471</td>
      <td>6.4690</td>
      <td>0.8723</td>
      <td>-0.0489</td>
      <td>0.9587</td>
      <td>-4.3281</td>
      <td>-2.8445</td>
      <td>-2.6723</td>
      <td>-1.1781</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1104</th>
      <td>065510</td>
      <td>휴비츠</td>
      <td>건강관리</td>
      <td>0.0332</td>
      <td>0.2584</td>
      <td>0.1424</td>
      <td>0.0175</td>
      <td>1.4274</td>
      <td>5.9676</td>
      <td>10.7512</td>
      <td>1.3809</td>
      <td>0.2877</td>
      <td>8.8179</td>
      <td>-3.1140</td>
      <td>-4.4123</td>
      <td>-3.1548</td>
      <td>-1.2448</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1230</th>
      <td>078930</td>
      <td>GS</td>
      <td>에너지</td>
      <td>0.0334</td>
      <td>0.1916</td>
      <td>0.0530</td>
      <td>0.0498</td>
      <td>0.2804</td>
      <td>2.3288</td>
      <td>2.0978</td>
      <td>0.1626</td>
      <td>-0.0568</td>
      <td>-4.9273</td>
      <td>-3.6757</td>
      <td>-7.3929</td>
      <td>-2.1004</td>
      <td>-1.4164</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1355</th>
      <td>091700</td>
      <td>파트론</td>
      <td>IT</td>
      <td>0.0413</td>
      <td>0.2419</td>
      <td>0.1983</td>
      <td>0.0414</td>
      <td>1.0801</td>
      <td>3.6878</td>
      <td>6.5336</td>
      <td>0.3716</td>
      <td>-0.1924</td>
      <td>0.5822</td>
      <td>-3.4513</td>
      <td>-5.8474</td>
      <td>-1.8014</td>
      <td>-1.2000</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1373</th>
      <td>093050</td>
      <td>LF</td>
      <td>경기관련소비재</td>
      <td>0.0296</td>
      <td>0.4546</td>
      <td>0.1277</td>
      <td>0.0348</td>
      <td>0.3386</td>
      <td>1.5947</td>
      <td>2.8577</td>
      <td>0.2733</td>
      <td>-0.0757</td>
      <td>-10.6219</td>
      <td>-3.7743</td>
      <td>-6.4244</td>
      <td>-2.2020</td>
      <td>-1.3573</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1380</th>
      <td>093520</td>
      <td>매커스</td>
      <td>IT</td>
      <td>0.0890</td>
      <td>0.2390</td>
      <td>0.1519</td>
      <td>0.0147</td>
      <td>1.7410</td>
      <td>4.8549</td>
      <td>4.8908</td>
      <td>0.8809</td>
      <td>0.2705</td>
      <td>31.4513</td>
      <td>-3.7958</td>
      <td>-2.9182</td>
      <td>-3.1964</td>
      <td>-1.2019</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1550</th>
      <td>122310</td>
      <td>제노레이</td>
      <td>건강관리</td>
      <td>0.0490</td>
      <td>0.3431</td>
      <td>0.1679</td>
      <td>0.0195</td>
      <td>1.6795</td>
      <td>7.8249</td>
      <td>8.5651</td>
      <td>1.6128</td>
      <td>-0.1412</td>
      <td>-10.3843</td>
      <td>-4.0464</td>
      <td>-4.0422</td>
      <td>-2.1898</td>
      <td>-1.1737</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1616</th>
      <td>137310</td>
      <td>에스디바이오센서</td>
      <td>건강관리</td>
      <td>0.1312</td>
      <td>0.5600</td>
      <td>0.3779</td>
      <td>0.0288</td>
      <td>2.1656</td>
      <td>4.1173</td>
      <td>4.1278</td>
      <td>1.4441</td>
      <td>-0.2674</td>
      <td>-19.4099</td>
      <td>-5.0051</td>
      <td>-4.7144</td>
      <td>-1.2990</td>
      <td>-1.2124</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1756</th>
      <td>194370</td>
      <td>제이에스코퍼레이션</td>
      <td>경기관련소비재</td>
      <td>0.0792</td>
      <td>0.3042</td>
      <td>0.0571</td>
      <td>0.0351</td>
      <td>1.2037</td>
      <td>7.3561</td>
      <td>3.8006</td>
      <td>0.2218</td>
      <td>-0.0552</td>
      <td>12.1466</td>
      <td>-3.3193</td>
      <td>-3.2803</td>
      <td>-2.7927</td>
      <td>-1.1098</td>
      <td>Y</td>
    </tr>
    <tr>
      <th>1780</th>
      <td>200880</td>
      <td>서연이화</td>
      <td>경기관련소비재</td>
      <td>0.0180</td>
      <td>0.1719</td>
      <td>0.0961</td>
      <td>0.0173</td>
      <td>0.3344</td>
      <td>1.3239</td>
      <td>4.6495</td>
      <td>0.1037</td>
      <td>0.0850</td>
      <td>-11.2004</td>
      <td>-2.1095</td>
      <td>-5.6999</td>
      <td>-2.5627</td>
      <td>-1.1398</td>
      <td>Y</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ol class="simple">
<li><p>각 팩터별 비중을 리스트로 만들며, 0.3으로 동일한 비중을 입력한다. 비중을 [0.2, 0.4, 0.4]와 같이 팩터별로 다르게 줄 수도 있으며, 이는 어떠한 팩터를 더욱 중요하게 생각하는지 혹은 더욱 좋게 보는지에 따라 조정이 가능하다.</p></li>
<li><p>팩터별 Z-Score와 비중의 곱을 구한 후 이를 합하며, 데이터프레임(data_bind_final_sum) 형태로 변경한다.</p></li>
<li><p>기존 테이블(data_bind)과 합친다.</p></li>
<li><p>최종 Z-Score의 합(qvm) 기준 순위가 1~20인 경우는 투자 종목에 해당하므로 ‘Y’, 그렇지 않으면 ‘N’으로 표시한다.</p></li>
</ol>
<p>최종 선택된 종목들을 보면 전반적으로 퀄리티가 높고, 밸류에이션이 낮으며, 최근 수익률이 높다. 물론 특정 팩터(예: 모멘텀)가 좋지 않아도 다른 팩터(예: 밸류)가 지나치게 좋아 선택되는 경우도 있다. 이제 선택된 종목들과 그렇지 않은 종목들간의 특성을 그림으로 표현해보겠다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="k">def</span> <span class="nf">plot_rank</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">relplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                     <span class="n">x</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span>
                     <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">col</span><span class="o">=</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span>
                     <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;invest&#39;</span><span class="p">,</span>
                     <span class="n">style</span><span class="o">=</span><span class="s1">&#39;invest&#39;</span><span class="p">,</span>
                     <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">],</span>
                     <span class="n">size</span><span class="o">=</span><span class="s1">&#39;invest&#39;</span><span class="p">,</span>
                     <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                     <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">,</span>
                     <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;lower center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">.1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>위 함수는 산점도를 표현하며 <span class="math notranslate nohighlight">\(x\)</span>축은 종목들의 순위, y축은 1, 색깔은 투자 여부인 invest에 따라 다르게 나타낸다. 해당 함수를 적용하기 위해 데이터프레임의 형태를 가공하도록 한다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_melt</span> <span class="o">=</span> <span class="n">port_qvm</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;invest&#39;</span><span class="p">,</span>
                          <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span>
                              <span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span> <span class="s1">&#39;CFO&#39;</span><span class="p">,</span> <span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PBR&#39;</span><span class="p">,</span> <span class="s1">&#39;PCR&#39;</span><span class="p">,</span> <span class="s1">&#39;PSR&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;DY&#39;</span><span class="p">,</span> <span class="s1">&#39;12M&#39;</span><span class="p">,</span> <span class="s1">&#39;K_ratio&#39;</span>
                          <span class="p">])</span>

<span class="n">data_melt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>invest</th>
      <th>variable</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>N</td>
      <td>ROE</td>
      <td>0.013900</td>
    </tr>
    <tr>
      <th>1</th>
      <td>N</td>
      <td>ROE</td>
      <td>-0.064580</td>
    </tr>
    <tr>
      <th>2</th>
      <td>N</td>
      <td>ROE</td>
      <td>0.010131</td>
    </tr>
    <tr>
      <th>3</th>
      <td>N</td>
      <td>ROE</td>
      <td>0.083880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>N</td>
      <td>ROE</td>
      <td>0.024646</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>data_bind에서 최종 선택 여부와 팩터별 값을 <code class="docutils literal notranslate"><span class="pre">melt()</span></code> 함수를 통해 세로로 긴 형태로 변경한다. 먼저 퀄리티 지표의 차이를 그림으로 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_quality</span> <span class="o">=</span> <span class="n">data_melt</span><span class="p">[</span><span class="n">data_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;GPA&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;CFO&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">hist_quality</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_quality</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
    <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plot_rank</span><span class="p">(</span><span class="n">hist_quality</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_146_0.png" src="_images/factor_146_0.png" />
</div>
</div>
<ol class="simple">
<li><p>퀄리티 지표가 포함된 데이터를 선택한다.</p></li>
<li><p>각 지표(variable)별 그룹을 묶은 후 순위를 계산한다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">plot_rank()</span></code> 함수를 통해 그림으로 나타낸다.</p></li>
</ol>
<p>붉은색 X 마크는 투자하는 종목, 회색 O 마크는 투자하지 않는 종목에 해당한다. 전반적으로 멀티팩터 기준으로 선정된 종목들의 퀄리티 순위가 높음을 알 수 있다.</p>
<p>이번에는 동일한 방법으로 밸류 지표의 차이를 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_value</span> <span class="o">=</span> <span class="n">data_melt</span><span class="p">[</span><span class="n">data_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;PER&#39;</span><span class="p">,</span> <span class="s1">&#39;PBR&#39;</span><span class="p">,</span> <span class="s1">&#39;PCR&#39;</span><span class="p">,</span> <span class="s1">&#39;PSR&#39;</span><span class="p">,</span> <span class="s1">&#39;DY&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">hist_value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hist_value</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">hist_value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">hist_value</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
<span class="n">hist_value</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_value</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
<span class="n">plot_rank</span><span class="p">(</span><span class="n">hist_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_148_0.png" src="_images/factor_148_0.png" />
</div>
</div>
<p>밸류 지표 역시 멀티팩터 기준으로 선정된 종목들의 순위가 높다. 그러나 사용되는 지표가 많은 만큼 일부 지표에서는 순위가 낮은 종목들이 선정되기도 한다.</p>
<p>이번에는 모멘텀 지표의 차이를 살펴보자.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_momentum</span> <span class="o">=</span> <span class="n">data_melt</span><span class="p">[</span><span class="n">data_melt</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;12M&#39;</span><span class="p">,</span> <span class="s1">&#39;K_ratio&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">hist_momentum</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist_momentum</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plot_rank</span><span class="p">(</span><span class="n">hist_momentum</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/factor_150_0.png" src="_images/factor_150_0.png" />
</div>
</div>
<p>모멘텀 지표 역시 멀티팩터 기준으로 선정된 종목들의 순위가 높다.</p>
<p>이처럼 멀티팩터 기준으로 종목을 선정할 경우 각 팩터가 골고루 좋은 종목을 선택할 수 있다. 이 외에도 팩터를 만들 수 있는 기본 데이터가 모두 있으므로 최근 적자기업 제외, 매출 증가 등 다양한 전략을 추가할 수도 있다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">port_qvm</span><span class="p">[</span><span class="n">port_qvm</span><span class="p">[</span><span class="s1">&#39;invest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">][</span><span class="s1">&#39;종목코드&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;model.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>마지막으로 모델 포트폴리오에 해당하는 종목들의 종목코드를 엑셀로 저장한다.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="data_ref.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">12. </span>투자 참고용 데이터 수집</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="portfolio.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">14. </span>포트폴리오 구성 전략</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By 이현열<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>